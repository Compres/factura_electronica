{"version":3,"file":"facelec.min.js","sources":["../../../../apps/factura_electronica/factura_electronica/public/js/facelec.js","../../../../apps/factura_electronica/factura_electronica/public/js/goalSeek.js","../../../../apps/factura_electronica/factura_electronica/public/js/sales_invoice.js","../../../../apps/factura_electronica/factura_electronica/public/js/delivery_note.js","../../../../apps/factura_electronica/factura_electronica/public/js/sales_order.js","../../../../apps/factura_electronica/factura_electronica/public/js/sales_quotation.js","../../../../apps/factura_electronica/factura_electronica/public/js/purchase_invoice.js","../../../../apps/factura_electronica/factura_electronica/public/js/purchase_receipt.js","../../../../apps/factura_electronica/factura_electronica/public/js/purchase_order.js","../../../../apps/factura_electronica/factura_electronica/public/js/supplier_quotation.js"],"sourcesContent":["console.log(\"Se cargo exitosamente la aplicación de Factura Electrónica\");\n/* 1 --------------------------------------------------------------------------------------------------------------- */\n/**\n * Funcionamiento: Valida que el Nit sea C/F o un numero de nit valido permitiendo\n * activar la opcion para guardar. Si el nit es invalido desactiva la funcion\n * guardar hasta que se ingrese uno correcto, esto permite no tener errores con\n * INFILE y tener los datos correctos.\n */\nexport function valNit(nit, cus_supp, frm) {\n\tvar nit_validado;\n\tif (nit === \"C/F\" || nit === \"c/f\") {\n\t\tfrm.enable_save(); // Activa y Muestra el boton guardar de Sales Invoice\n\t} else {\n\t\tvar nd, add = 0;\n\t\tif (nd = /^(\\d+)\\-?([\\dk])$/i.exec(nit)) {\n\t\t\tnd[2] = (nd[2].toLowerCase() == 'k') ? 10 : parseInt(nd[2]);\n\t\t\tfor (var i = 0; i < nd[1].length; i++) {\n\t\t\t\tadd += ((((i - nd[1].length) * -1) + 1) * nd[1][i]);\n\t\t\t}\n\t\t\tnit_validado = ((11 - (add % 11)) % 11) == nd[2];\n\t\t} else {\n\t\t\tnit_validado = false;\n\t\t}\n\n\t\tif (nit_validado === false) {\n\t\t\tfrappe.show_alert({\n\t\t\t\tindicator: 'orange',\n\t\t\t\tmessage: __(`\n\t\t\t\tNIT de <a href= '#Form/Customer/${cus_supp}'><b>${cus_supp}</b></a> no es correcto. Si no tiene disponible el NIT modifiquelo a C/F.\n\t\t\t\t`)\n\t\t\t});\n\n\t\t\tfrm.disable_save(); // Desactiva y Oculta el boton de guardar en Sales Invoice\n\t\t}\n\t\tif (nit_validado === true) {\n\t\t\tfrm.enable_save(); // Activa y Muestra el boton guardar de Sales Invoice\n\t\t}\n\t}\n}\n\n/* ----------------------------------------------------------------------------------------------------------------- */\n/** Verificacion para que exista un solo check */\nfrappe.ui.form.on(\"Item\", {\n\tfacelec_is_fuel: function (frm, cdt, cdn) {\n\t\tif (frm.doc.facelec_is_fuel) {\n\t\t\tcur_frm.set_value(\"facelec_is_good\", 0);\n\t\t\tcur_frm.set_value(\"facelec_is_service\", 0);\n\t\t}\n\t},\n\tfacelec_is_good: function (frm, cdt, cdn) {\n\t\tif (frm.doc.facelec_is_good) {\n\t\t\tcur_frm.set_value(\"facelec_is_fuel\", 0);\n\t\t\tcur_frm.set_value(\"facelec_is_service\", 0);\n\t\t}\n\t},\n\tfacelec_is_service: function (frm, cdt, cdn) {\n\t\tif (frm.doc.facelec_is_service) {\n\t\t\tcur_frm.set_value(\"facelec_is_fuel\", 0);\n\t\t\tcur_frm.set_value(\"facelec_is_good\", 0);\n\t\t}\n\t}\n});\n\n// Validador NIT para customer\nfrappe.ui.form.on(\"Customer\", {\n\tnit_face_customer: function (frm) {\n\t\tvalNit(frm.doc.nit_face_customer, frm.doc.name, frm);\n\t}\n});\n// Validador NIT para Supplier\nfrappe.ui.form.on(\"Supplier\", {\n\tfacelec_nit_proveedor: function (frm) {\n\t\tvalNit(frm.doc.facelec_nit_proveedor, frm.doc.name, frm);\n\t}\n});\n/* en-US: INDIVIDUAL SOURCE CODE FROM .js FILES IN THIS DIRECTORY WILL BE ADDED WHEN DOING A BENCH BUILD\n   es-GT: CODIGO FUENTE INDIVIDUAL DE ARCHIVOS .js EN ESTE DIRECTORIO SE AGREGARAN ABAJO AL HACER BENCH BUILD */\n\n// ================================================================================================================ //\n","export function goalSeek(oParams) {\n\tvar g, Y, Y1, OldTarget;\n\n\toParams.Tol = (oParams.Tol || 0.001 * oParams.Goal || 0.1);\n\toParams.maxIter = (oParams.maxIter || 1000);\n\n\t//is the independent variable within an object?\n\tif (oParams.oFuncArgTarget.propStr) {\n\t\t//check if a guess has been provided\n\t\tif (!oParams.aFuncParams[oParams.oFuncArgTarget.Position][oParams.oFuncArgTarget.propStr]) {\n\t\t\t//iterate through 100 guesses, max\n\t\t\tfor (var i = 0; i < 100; i++) {\n\t\t\t\tvar iGuess = Math.random();\n\t\t\t\tsetObjVal(oParams.aFuncParams[oParams.oFuncArgTarget.Position], oParams.oFuncArgTarget.propStr, iGuess);\n\t\t\t\tif (oParams.Func.apply(oParams.This, oParams.aFuncParams)) {\n\t\t\t\t\tbreak;\n\t\t\t\t};\n\t\t\t\tif (i === 99) {\n\t\t\t\t\t//we couldn't find any guess that worked!\n\t\t\t\t\treturn null;\n\t\t\t\t};\n\t\t\t};\n\t\t};\n\n\t\t//Iterate through the guesses\n\t\tfor (var i = 0; i < oParams.maxIter; i++) {\n\t\t\t//define the root of the function as the error\n\t\t\tY = oParams.Func.apply(oParams.This, oParams.aFuncParams) - oParams.Goal;\n\n\t\t\t//was our initial guess a good one?\n\t\t\tif (Math.abs(Y) <= oParams.Tol) {\n\t\t\t\treturn getObjVal(oParams.aFuncParams[oParams.oFuncArgTarget.Position], oParams.oFuncArgTarget.propStr);\n\t\t\t} else {\n\t\t\t\tOldTarget = getObjVal(oParams.aFuncParams[oParams.oFuncArgTarget.Position], oParams.oFuncArgTarget.propStr);\n\t\t\t\tsetObjVal(oParams.aFuncParams[oParams.oFuncArgTarget.Position], oParams.oFuncArgTarget.propStr, OldTarget + Y);\n\t\t\t\tY1 = oParams.Func.apply(oParams.This, oParams.aFuncParams) - oParams.Goal;\n\t\t\t\tg = (Y1 - Y) / Y;\n\n\t\t\t\tif (g === 0) {\n\t\t\t\t\tg = 0.0001;\n\t\t\t\t};\n\n\t\t\t\tsetObjVal(oParams.aFuncParams[oParams.oFuncArgTarget.Position], oParams.oFuncArgTarget.propStr, OldTarget - Y / g);\n\t\t\t};\n\n\t\t};\n\t\tif (Math.abs(Y) > oParams.Tol) {\n\t\t\treturn null;\n\t\t};\n\t} else {\n\t\t//check if a guess has been provided\n\t\tif (!oParams.aFuncParams[oParams.oFuncArgTarget.Position]) {\n\t\t\t//iterate through 100 guesses, max\n\t\t\tfor (var i = 0; i < 100; i++) {\n\t\t\t\tvar iGuess = Math.random();\n\t\t\t\toParams.aFuncParams[oParams.oFuncArgTarget.Position] = iGuess;\n\t\t\t\tif (oParams.Func.apply(oParams.This, oParams.aFuncParams)) {\n\t\t\t\t\tbreak;\n\t\t\t\t};\n\t\t\t\tif (i === 99) {\n\t\t\t\t\t//we couldn't find any guess that worked!\n\t\t\t\t\treturn null;\n\t\t\t\t};\n\t\t\t};\n\t\t};\n\n\t\t//Iterate through the guesses\n\t\tfor (var i = 0; i < oParams.maxIter; i++) {\n\t\t\t//define the root of the function as the error\n\t\t\tY = oParams.Func.apply(oParams.This, oParams.aFuncParams) - oParams.Goal;\n\t\t\t//was our initial guess a good one?\n\t\t\tif (Math.abs(Y) <= oParams.Tol) {\n\t\t\t\treturn oParams.aFuncParams[oParams.oFuncArgTarget.Position];\n\t\t\t} else {\n\t\t\t\tOldTarget = oParams.aFuncParams[oParams.oFuncArgTarget.Position];\n\t\t\t\toParams.aFuncParams[oParams.oFuncArgTarget.Position] = OldTarget + Y;\n\t\t\t\tY1 = oParams.Func.apply(oParams.This, oParams.aFuncParams) - oParams.Goal;\n\t\t\t\tg = (Y1 - Y) / Y;\n\n\t\t\t\tif (g === 0) {\n\t\t\t\t\tg = 0.0001;\n\t\t\t\t};\n\n\t\t\t\toParams.aFuncParams[oParams.oFuncArgTarget.Position] = OldTarget - Y / g;\n\t\t\t};\n\n\t\t};\n\t\tif (Math.abs(Y) > oParams.Tol) {\n\t\t\treturn null;\n\t\t};\n\t};\n};\n\n//source (modified from original): http://stackoverflow.com/questions/18936915/dynamically-set-property-of-nested-object\n//answerer: bpmason1; questioner: John B.\n//answerer url: http://stackoverflow.com/users/2736119/bpmason1\n//license: http://creativecommons.org/licenses/by-sa/3.0/legalcode\nfunction setObjVal(Obj, propStr, Value) {\n\tvar Schema = Obj;  // a moving reference to internal objects within obj\n\tvar pList = propStr.split('.');\n\tvar Len = pList.length;\n\n\tfor (var i = 0; i < Len - 1; i++) {\n\t\tvar Elem = pList[i];\n\t\tif (!Schema[Elem]) Schema[Elem] = {}\n\t\tSchema = Schema[Elem];\n\t};\n\n\tSchema[pList[Len - 1]] = Value;\n};\n\n//source (modified from original): http://stackoverflow.com/questions/4343028/in-javascript-test-for-property-deeply-nested-in-object-graph\n//answerer: Zach; questioner: thisismyname\n//answerer url: http://stackoverflow.com/users/230892/zach\n//license: http://creativecommons.org/licenses/by-sa/3.0/legalcode\nfunction getObjVal(Obj, propStr) {\n\tvar Parts = propStr.split(\".\");\n\tvar Cur = Obj;\n\n\tfor (var i = 0; i < Parts.length; i++) {\n\t\tCur = Cur[Parts[i]];\n\t};\n\n\treturn Cur;\n};\n","/**\n * Copyright (c) 2017, 2018 SHS and contributors\n * For license information, please see license.txt\n */\n\nimport { valNit } from './facelec.js';\nimport { goalSeek } from './goalSeek.js';\n\n/* 1 Funcion calculadora para Sales Invoice ------------------------------------------------------------------------ */\nfunction facelec_tax_calc_new(frm, cdt, cdn) {\n    // es-GT: Actualiza los datos en los campos de la tabla hija 'items'\n    //console.log(\"ran facelec_tax_calc_new\");\n    // es-GT: Revisamos si ya quedo cargado y definido el rate (tasa) de impuesto en el DocType, el cual debe estar en la fila 0 de Sales Taxes & Charges.\n    // es-GT: Si no ha sido definido, no se hace nada. Si ya fue definido, se asigna a una variable el valor que encuentre en la fila 0 de la tabla hija taxes.\n    var this_company_sales_tax_var;\n    if (cur_frm.doc.taxes[0].rate !== \"undefined\") {\n        //console.log(\"Ahora que ya se especifico un cliente, ya existe impuesto en la hoja, por lo tanto, lo asignamos a una variable!\");\n        this_company_sales_tax_var = cur_frm.doc.taxes[0].rate;\n        //console.log(\"El IVA cargado es: \" + this_company_sales_tax_var);\n    }\n    // es-GT: Ahora se hace con un event listener al primer teclazo del campo de cliente\n    // es-GT: Sin embargo queda aqui para asegurar que el valor sea el correcto en todo momento.\n    // var this_row_qty = 0;\n    // var this_row_rate = 0;\n    var this_row_amount = 0;\n    // var this_row_conversion_factor = 0;\n    var this_row_stock_qty = 0;\n    var this_row_tax_rate = 0;\n    var this_row_tax_amount = 0;\n    var this_row_taxable_amount = 0;\n    // var total_fuel = 0;\n    // var total_goods = 0;\n    // var total_servi = 0;\n\n    // es-GT: Esta funcion permite trabajar linea por linea de la tabla hija items\n    //OJO! FIXME Queda pendiente trabajar la forma de que el control o pop up que contiene estos datos, a la hora de cambiar conversion factor, funcione adecuadamente sin depender en un mouse click fuera del campo o que se tenga que guardar. Por ahora solo con hacer click afuera del campo o guardar o ingresar a otro campo con la funcion each_item, se actualiza correctamente.  Es un fix temporal, aunque se debe siempre guardar cualquier documento, y al validar tambien se debe correr correctamente!\n    frm.doc.items.forEach((item_row, index) => {\n        if (item_row.name === cdn) {\n            // first we calculate the amount total for this row and assign it to a variable\n            //this_row_amount = (item_row.qty * item_row.rate);\n            this_row_amount = item_row.amount;\n            // Now, we get the quantity in terms of stock quantity by multiplying by conversion factor\n            this_row_stock_qty = item_row.stock_qty;\n            // We then assign the tax rate per stock UOM to a variable\n            this_row_tax_rate = item_row.facelec_tax_rate_per_uom;\n            // We calculate the total amount of excise or special tax based on the stock quantity and tax rate per uom variables above.\n            this_row_tax_amount = (item_row.stock_qty * item_row.facelec_tax_rate_per_uom);\n            // We then estimate the remainder taxable amount for which Other ERPNext configured taxes will apply.\n            this_row_taxable_amount = (item_row.amount - (item_row.stock_qty * item_row.facelec_tax_rate_per_uom));\n            // We change the fields for other tax amount as per the complete row taxable amount.\n            frm.doc.items[index].facelec_other_tax_amount = ((item_row.facelec_tax_rate_per_uom * (item_row.qty * item_row.conversion_factor)));\n            frm.doc.items[index].facelec_amount_minus_excise_tax = ((item_row.qty * item_row.rate) - (item_row.stock_qty * item_row.facelec_tax_rate_per_uom));\n            // We refresh the items to recalculate everything to ensure proper math\n            frm.refresh_field(\"items\");\n            //console.log(item_row.qty + \" \" + item_row.uom + \"es/son igual/es a \" + item_row.stock_qty + \" \" + item_row.stock_uom);\n            //console.log(\"conversion_factor is: \" + item_row.conversion_factor);\n            // Probando refrescar el campo de converison factor, talvez asi queda todo nitido??  TODO\n            frm.refresh_field(\"conversion_factor\");\n            //console.log(\"Other tax amount = Q\" + (item_row.stock_qty * item_row.facelec_tax_rate_per_uom));\n            //console.log(\"Amount - Other Tax Amount = Amount minus excise tax: \" + item_row.amount + \" - \" + (item_row.stock_qty * item_row.facelec_tax_rate_per_uom) + \" = \" + item_row.facelec_amount_minus_excise_tax);\n            //console.log(\"Q\" + item_row.amount + \" - (\" + item_row.stock_qty + \" * \" + item_row.facelec_tax_rate_per_uom + \") \")\n\n            // Verificacion Individual para verificar si es Fuel, Good o Service\n            if (item_row.factelecis_fuel) {\n                frm.doc.items[index].facelec_gt_tax_net_fuel_amt = (item_row.facelec_amount_minus_excise_tax / (1 + (this_company_sales_tax_var / 100)));\n                frm.doc.items[index].facelec_sales_tax_for_this_row = (item_row.facelec_gt_tax_net_fuel_amt * (this_company_sales_tax_var / 100));\n                // Sumatoria de todos los que tengan el check combustibles\n\t\t\t\t/*\n\t\t\t\tvar total_fuel = 0;\n\t\t\t\t$.each(frm.doc.items || [], function (i, d) {\n\t\t\t\t\t// total_qty += flt(d.qty);\n\t\t\t\t\tif (d.factelecis_fuel) {\n\t\t\t\t\t\ttotal_fuel += flt(d.facelec_gt_tax_net_fuel_amt);\n\t\t\t\t\t};\n\t\t\t\t});\n\t\t\t\t//console.log(\"El total neto de fuel es:\" + total_fuel); // WORKS OK!\n\t\t\t\t// cur_frm.doc.facelec_gt_tax_fuel = total_fuel;\n\t\t\t\tcur_frm.set_value('facelec_gt_tax_fuel', total_fuel);\n\t\t\t\tfrm.refresh_field(\"factelecis_fuel\");\n                */\n            };\n            if (item_row.facelec_is_good) {\n                frm.doc.items[index].facelec_gt_tax_net_goods_amt = (item_row.facelec_amount_minus_excise_tax / (1 + (this_company_sales_tax_var / 100)));\n                frm.doc.items[index].facelec_sales_tax_for_this_row = (item_row.facelec_gt_tax_net_goods_amt * (this_company_sales_tax_var / 100));\n                // Sumatoria de todos los que tengan el check bienes\n\t\t\t\t/*\n\t\t\t\tvar total_goods = 0;\n\t\t\t\t$.each(frm.doc.items || [], function (i, d) {\n\t\t\t\t\t// total_qty += flt(d.qty);\n\t\t\t\t\tif (d.facelec_is_good) {\n\t\t\t\t\t\ttotal_goods += flt(d.facelec_gt_tax_net_goods_amt);\n\t\t\t\t\t};\n\t\t\t\t});\n\t\t\t\tconsole.log(\"El total neto de bienes es:\" + total_goods); // WORKS OK!\n\t\t\t\t// cur_frm.doc.facelec_gt_tax_goods = total_goods;\n\t\t\t\tcur_frm.set_value('facelec_gt_tax_goods', total_goods);\n\t\t\t\t*/\n            };\n            if (item_row.facelec_is_service) {\n                //console.log(\"The item you added is a SERVICE!\" + item_row.facelec_is_service);// WORKS OK!\n                //console.log(\"El valor en servicios para el libro de compras es: \" + net_services_tally);// WORKS OK!\n                // Estimamos el valor del IVA para esta linea\n                //frm.doc.items[index].facelec_sales_tax_for_this_row = (item_row.facelec_amount_minus_excise_tax * (this_company_sales_tax_var / 100)).toFixed(2);\n                //frm.doc.items[index].facelec_gt_tax_net_services_amt = (item_row.facelec_amount_minus_excise_tax - item_row.facelec_sales_tax_for_this_row).toFixed(2);\n                frm.doc.items[index].facelec_gt_tax_net_services_amt = (item_row.facelec_amount_minus_excise_tax / (1 + (this_company_sales_tax_var / 100)));\n                frm.doc.items[index].facelec_sales_tax_for_this_row = (item_row.facelec_gt_tax_net_services_amt * (this_company_sales_tax_var / 100));\n\t\t\t\t/*\n\t\t\t\tvar total_servi = 0;\n\t\t\t\t$.each(frm.doc.items || [], function (i, d) {\n\t\t\t\t\tif (d.facelec_is_service) {\n\t\t\t\t\t\ttotal_servi += flt(d.facelec_gt_tax_net_services_amt);\n\t\t\t\t\t\tconsole.log(\"se detecto cheque de servicio\"); // WORKS!\n\t\t\t\t\t};\n\t\t\t\t});\n\t\t\t\tconsole.log(\"El total neto de servicios es:\" + total_servi); // WORKS OK!\n\t\t\t\t// cur_frm.doc.facelec_gt_tax_services = total_servi;\n\t\t\t\tcur_frm.set_value('facelec_gt_tax_services', total_servi);\n\t\t\t\t*/\n            };\n            // Para el calculo total de IVA, basado en la sumatoria de facelec_sales_tax_for_this_row de cada item\n\t\t\t/*\n\t\t\tvar full_tax_iva = 0;\n\t\t\t$.each(frm.doc.items || [], function (i, d) {\n\t\t\t\tfull_tax_iva += flt(d.facelec_sales_tax_for_this_row);\n\t\t\t});\n\t\t\t// Seccion Guatemala Tax: Se asigna al campo de IVA de la seccion\n\t\t\t// frm.doc.facelec_total_iva = full_tax_iva;\n\t\t\tcur_frm.set_value('facelec_total_iva', full_tax_iva);\n            */\n\n            var total_iva_factura = 0;\n            $.each(frm.doc.items || [], function (i, d) {\n                if (d.facelec_sales_tax_for_this_row) {\n                    total_iva_factura += flt(d.facelec_sales_tax_for_this_row);\n                };\n            });\n            // console.log(\"El total de iva acumulado para la factura es: \" + total_iva_factura);\n            cur_frm.set_value('shs_total_iva_fac', total_iva_factura);\n        };\n    });\n\n}\n\n// Sin necesidad de guardar el formulario.  Esto costo una buenas horas de trabajo!!\n// Se lanza con un evento disparado por un escuchador\n// FIXME: Lo unico es que solo se puede poner item code con ENTER o CLICK. Tab no funciona.  Quizas aqui si sirve usar un listener de keypress para guardarlo en una variable que lo hace permanecer mientras se escribe el item.\n// Esto soluciona el issue #18\nfunction each_item(frm, cdt, cdn) {\n    // es-GT: Esta permite ya que se calcule correctamente desde el INICIO!\n    // es-GT: Sin necesidad de Guardar antes!\n    frm.doc.items.forEach((item) => {\n        // for each button press each line is being processed.\n        //console.log(\"Item, from the each_item function contains: \" + item);\n        //Esato dice: object, object\n        //Importante\n        var tax_before_calc = frm.doc.facelec_total_iva;\n        //console.log(\"El descuento total es:\" + frm.doc.discount_amount);\n        //console.log(\"El IVA calculado anteriormente:\" + frm.doc.facelec_total_iva);\n        var discount_amount_net_value = (frm.doc.discount_amount / (1 + (cur_frm.doc.taxes[0].rate / 100)));\n        if (typeof (cur_frm.doc.taxes[0].rate) == \"NaN\") {\n            //console.log(\"No hay descuento definido, calculando sin descuento.\");\n        } else {\n            //console.log(\"El descuento parece ser un numero definido, calculando con descuento.\");\n            //console.log(\"El neto sin iva del descuento es\" + discount_amount_net_value);\n            var discount_amount_tax_value = (discount_amount_net_value * (cur_frm.doc.taxes[0].rate / 100));\n            //console.log(\"El IVA del descuento es:\" + discount_amount_tax_value);\n            frm.doc.facelec_total_iva = (frm.doc.facelec_total_iva - discount_amount_tax_value);\n            //console.log(\"El IVA ya sin el iva del descuento es ahora:\" + frm.doc.facelec_total_iva);\n        }\n        facelec_tax_calc_new(frm, \"Sales Invoice Item\", item.name);\n        facelec_otros_impuestos_fila(frm, \"Sales Invoice Item\", item.name);\n    });\n}\n\n/* 2 --------------------------------------------------------------------------------------------------------------- */\n\n/* 3 Funciones para otros impuestos IDP ... ------------------------------------------------------------------------ */\n/**\n * Parametros:\n * #1 frm = formulario que se esta trabajando\n * #2 tax_account = nombre de la cuenta\n *\n * Funcionamiento:\n * Recorre la tabla items, por cada item que encuentre con el nombre de\n * cuenta recibido, lo ira concatenando en una variable que al finalizar\n * el recorrido de la tabla lo retornara a quien haya invocado la fucnion\n */\nfunction facelec_add_taxes(frm, tax_account) {\n    var total_sumatoria = 0;\n\n    $.each(frm.doc.items || [], function (i, d) {\n        if (d.facelec_tax_rate_per_uom_account === tax_account) {\n            total_sumatoria += flt(d.facelec_other_tax_amount);\n        };\n    });\n\n    return total_sumatoria;\n}\n\n/**\n * Parametros:\n * #1 frm = formulario que se esta trabajando\n * #2 cdt = Doctype\n * #3 cdn = Docname\n *\n * Funcionamiento:\n * Recorre la tabla items, por cada item encontrado, si tiene una cuenta asignada,\n * recorrera la tabla hija shs_otros_impuestos en busca de cuentas con el mismo nombre\n * de cuenta anteriormente encontrado, para totalizar el valor del impuestos, para todos\n * los items que tienen la misma cuenta configurada.\n */\nfunction sumar_otros_impuestos_shs(frm, cdt, cdn) {\n    frm.doc.items.forEach((item_row_1, index_1) => {\n\n        if (item_row_1.name === cdn) {\n            if (item_row_1.facelec_tax_rate_per_uom_account) {\n                if (frm.doc.shs_otros_impuestos !== undefined) {\n                    frm.doc.shs_otros_impuestos.forEach((tax_row_2, index_2) => {\n                        if (tax_row_2.account_head === item_row_1.facelec_tax_rate_per_uom_account) {\n                            var totalizador = 0;\n                            totalizador = facelec_add_taxes(frm, tax_row_2.account_head)\n                            cur_frm.doc.shs_otros_impuestos[index_2].total = totalizador;\n                            shs_total_other_tax(frm);\n                        }\n                    });\n                }\n\n            }\n        }\n    });\n}\n\n/**\n * Parametros:\n * #1 frm = formulario que se esta trabajando\n *\n * Funcionamiento:\n * Recorre la tabla hija shs_otros_impuestos, realiza sumatoria de todos las filas\n * que tenga una cuenta, el valor totalizado se asigna al campo shs_total_otros_imp_incl\n */\nfunction shs_total_other_tax(frm) {\n    var total_tax = 0;\n\n    $.each(frm.doc.shs_otros_impuestos || [], function (i, d) {\n        if (d.account_head) {\n            total_tax += flt(d.total);\n        };\n    });\n\n    cur_frm.set_value('shs_total_otros_imp_incl', total_tax);\n    frm.refresh_field(\"shs_total_otros_imp_incl\");\n}\n\n/**\n * Parametros:\n * #1 frm = formulario que se esta trabajando\n * #2 cdt = Doctype\n * #3 cdn = Docname\n *\n * Funcionamiento:\n * Recorre la tabla items, por cada fila con una cuenta asignada buscara en la tabla hija\n * shs_otros_impuestos por una fila con el mismo nombre de la cuenta anteriormente encontrada,\n * si no la encuentra en shs_otros_impuestos creara una nueva fila, y le asignara los valores\n * de nombre de cuenta y el total para esa cuenta. Si la cuenta ya se encuentra creada en\n * shs_otros_impuestos le sumara los valores encontrados.\n */\nfunction facelec_otros_impuestos_fila(frm, cdt, cdn) {\n    var this_row_tax_amount = 0; // Valor IDP\n    var this_row_taxable_amount = 0; // Valor todavía con IVA\n    var shs_otro_impuesto = 0;\n    var total_suma_impuesto = 0;\n\n    frm.doc.items.forEach((item_row_i, indice) => {\n        if (item_row_i.name === cdn) {\n            // Calculos Alain\n            this_row_tax_amount = (item_row_i.stock_qty * item_row_i.facelec_tax_rate_per_uom);\n            //this_row_taxable_amount = (item_row_i.amount - (item_row_i.stock_qty * item_row_i.facelec_tax_rate_per_uom));\n            shs_otro_impuesto = item_row_i.facelec_other_tax_amount;\n\n            // Guarda el nombre de la cuenta del item seleccionado\n            var cuenta = item_row_i.facelec_tax_rate_per_uom_account;\n            //console.log('Cuenta de item encontrada es : ' + cuenta);\n\n            // Refresh data de la tabla hija items y conversion_factor\n            frm.refresh_field('items');\n            frm.refresh_field('conversion_factor');\n\n            if (cuenta) { // Si encuentra una cuenta con nombre procede\n                var otro_impuesto = this_row_tax_amount;\n                //valor_con_iva = this_row_taxable_amount;\n\n                if (!(buscar_account(frm, cuenta))) { // Si no encuentra una cuenta, procede.\n                    // var fila_nueva = cur_frm.add_child(\"shs_otros_impuestos\");\n                    // var fila_nueva = frappe.model.add_child(cur_frm.doc, \"Otros Impuestos Factura Electronica\", \"shs_otros_impuestos\");\n                    // Crea una nueva fila vacia en la tabla hija shs_otros_impuestos\n                    frappe.model.add_child(cur_frm.doc, \"Otros Impuestos Factura Electronica\", \"shs_otros_impuestos\");\n\n                    // Refresh datos de la tabla hija items\n                    cur_frm.refresh_field('items');\n                    // otro_impuesto = this_row_tax_amount;\n                    // valor_con_iva = this_row_taxable_amount;\n\n                    // Recorre la tabla hija 'taxes' en busca de la nueva fila que se agrego anteriormente donde account_head\n                    // sea undefined\n                    frm.doc.shs_otros_impuestos.forEach((tax_row, index) => {\n                        // Si encuentra la fila anteriormente agregada procede\n                        if (tax_row.account_head === undefined) {\n                            // Asigna valores en la fila recien creada\n                            cur_frm.doc.shs_otros_impuestos[index].account_head = cuenta;\n                            cur_frm.doc.shs_otros_impuestos[index].total = shs_otro_impuesto;\n                            // cur_frm.doc.shs_otros_impuestos[index].doctype_type = 'Sales Invoice';\n                            // cur_frm.doc.shs_otros_impuestos[index].doctype_no = cdn;\n\n                            // Actualiza los datos de la tabla hija\n                            cur_frm.refresh_field(\"shs_otros_impuestos\");\n\n                            // Funcion que se encarga de sumar los valores por cuenta\n                            sumar_otros_impuestos_shs(frm, cdt, cdn);\n                            cur_frm.refresh_field(\"shs_otros_impuestos\");\n                        }\n                    });\n\n                } else { // Si la cuenta ya esta agregada en shs_otros_impuestos, se procede a sumar sobre los valores\n                    // ya existentes\n                    // Funcion que se encarda de sumar los valores por cuenta\n                    sumar_otros_impuestos_shs(frm, cdt, cdn);\n                    cur_frm.refresh_field(\"shs_otros_impuestos\");\n                }\n            }\n        }\n    });\n\n}\n\nfunction totalizar_valores(frm, cdn, tax_account_n, otro_impuesto) {\n\t/**\n\t * Se encarga de recalcular el total de otros impuestos cuando se elimina un item\n\t */\n    // console.log('Otro Impuesto recibido es : ' + otro_impuesto);\n    // recorre items\n    frm.doc.items.forEach((item_row, i1) => {\n        if (item_row.facelec_tax_rate_per_uom_account === tax_account_n) {\n            var total = (facelec_add_taxes(frm, tax_account_n) - otro_impuesto);\n            // recorre shs_otros_impuestos\n            //console.log('1. El nuevo total calculado es: ' + total);\n            //console.log('1. El valor de la fila que se borra es: ' + otro_impuesto);\n\n            if (frm.doc.shs_otros_impuestos !== undefined) {\n                frm.doc.shs_otros_impuestos.forEach((tax_row, i2) => {\n                    if (tax_row.account_head === tax_account_n) {\n                        cur_frm.doc.shs_otros_impuestos[i2].total = total;\n                        cur_frm.refresh_field(\"shs_otros_impuestos\");\n                        shs_total_other_tax(frm);\n                        cur_frm.refresh_field(\"shs_otros_impuestos\");\n\n                        if (!tax_row.total) {\n                            // console.log('SE ELIMINARA LA FILA ---------------->');\n                            // Elimina la fila con valor 0\n                            cur_frm.doc.shs_otros_impuestos.splice(cur_frm.doc.shs_otros_impuestos[i2], 1);\n                            cur_frm.refresh_field(\"shs_otros_impuestos\");\n                        }\n                    }\n                });\n            }\n\n        }\n    });\n\n}\n/* 4 --------------------------------------------------------------------------------------------------------------- */\n/**\n * Funcionamiento: recibe como parametro frm, y cuenta_b, lo que hace es, buscar en todas las filas de taxes\n * si existe ya una cuenta con el nombre de la cuenta recibida por parametro, en caso ya exista esa cuenta en\n * la tabla no hace nada, pero si encuentra que no hay una cuenta igual a la recibida en el parametro, entonces\n * la funcion encargada agregara una nueva fila con los datos correspondientes, esta funcion retorna true\n * en caso si encuentre una cuenta existente\n */\nfunction buscar_account(frm, cuenta_b) {\n    var estado = false;\n\n    $.each(frm.doc.shs_otros_impuestos || [], function (i, d) {\n        if (d.account_head === cuenta_b) {\n            // console.log('Si Existe en el indice ' + i)\n            estado = true;\n        }\n    });\n\n    return estado;\n}\n\n/* 6 Funciones creadoras de botones --------------------------------------------------------------------------------------- */\nfunction pdf_button(cae_documento, frm) {\n    // Esta funcion se encarga de mostrar el boton para obtener el pdf de la factura electronica generada\n    frm.add_custom_button(__(\"VER PDF FACTURA ELECTRONICA\"),\n        function () {\n            window.open(\"https://www.ingface.net/Ingfacereport/dtefactura.jsp?cae=\" + cae_documento);\n        }).addClass(\"btn-primary\");\n}\n\n/*\nCrea un boton que permite guardar el PDF de factura electronica generado en el servidor\nde forma privada, tras finalizar la ejecucion del script del lado del servidor en el\ncallback se recarga la pagina para mostrar el archivo adjunto.\n*/\nfunction guardar_pdf(frm) {\n    frm.add_custom_button(__('GUARDAR PDF'), function () {\n        frappe.call({\n            method: \"factura_electronica.api.guardar_pdf_servidor\",\n            args: {\n                nombre_archivo: frm.doc.name,\n                cae_de_factura_electronica: frm.doc.cae_factura_electronica\n            },\n            callback: function () {\n                frm.reload_doc();\n            }\n        });\n    }).addClass(\"btn-primary\"); //NOTA: Se puede crear una clase para el boton CSS\n}\n\n// FIXME: MODIFICAR PARA QUE PERMITE ELIMINAR EL PDF\nfunction eliminar_pdf() {\n    frm.add_custom_button(__('ELIMINAR PDF'), function () {\n        frappe.call({\n            method: \"factura_electronica.api.guardar_pdf_servidor\",\n            args: {\n                nombre_archivo: frm.doc.name,\n                cae_de_factura_electronica: frm.doc.cae_factura_electronica\n            },\n            callback: function () {\n                frm.reload_doc();\n            }\n        });\n    }).addClass(\"btn-primary\");\n}\n\nfunction generar_boton_factura(tipo_factura, frm) {\n    frm.add_custom_button(__(tipo_factura), function () {\n        // frm.reload(); permite hacer un refresh de todo el documento\n        frm.reload_doc();\n        let serie_de_factura = frm.doc.name;\n        // Guarda la url actual\n        let mi_url = window.location.href;\n        frappe.call({\n            method: \"factura_electronica.api.generar_factura_electronica\",\n            args: {\n                serie_factura: frm.doc.name,\n                nombre_cliente: frm.doc.customer,\n                pre_se: frm.doc.naming_series\n            },\n            // El callback recibe como parametro el dato retornado por el script python del lado del servidor\n            callback: function (data) {\n                if (data.message !== undefined) {\n                    // Crea una nueva url con el nombre del documento actualizado\n                    let url_nueva = mi_url.replace(serie_de_factura, data.message);\n                    // Asigna la nueva url a la ventana actual\n                    window.location.assign(url_nueva);\n                    // Recarga la pagina\n                    frm.reload_doc();\n                }\n            }\n        });\n    }).addClass(\"btn-primary\"); //NOTA: Se puede crear una clase para el boton CSS\n}\n\n// Realiza la funcionalidad del boton automaticamente\nfunction generar_factura_sin_btn(frm) {\n    // frm.reload(); permite hacer un refresh de todo el documento\n    frm.reload_doc();\n    let serie_de_factura = frm.doc.name;\n    // Guarda la url actual\n    let mi_url = window.location.href;\n    frappe.call({\n        method: \"factura_electronica.api.generar_factura_electronica\",\n        args: {\n            serie_factura: frm.doc.name,\n            nombre_cliente: frm.doc.customer,\n            pre_se: frm.doc.naming_series\n        },\n        // El callback recibe como parametro el dato retornado por el script python del lado del servidor\n        callback: function (data) {\n            if (data.message !== undefined) {\n                // Crea una nueva url con el nombre del documento actualizado\n                let url_nueva = mi_url.replace(serie_de_factura, data.message);\n                // Asigna la nueva url a la ventana actual\n                window.location.assign(url_nueva);\n                frm.reload_doc();\n            } else {\n                frm.reload_doc();\n            }\n        }\n    });\n}\n\n/* 7 Funciones Verificadoras ------------------------------------------------------------------------------------------------- */\nfunction verificacionCAE(modalidad, frm, cdt, cdn) {\n    /* ------------------------------ COMPROBACIONES DE CAE ------------------------------ */\n    // FACTURAS FACE, CFACE\n    // Este codigo entra en funcionamiento cuando la generacion automatica de la factura no es exitosa.\n    // esto permite volver intentarlo hasta obtener el cae de la factura en que se estre trabajando.\n    if (frm.doc.status === \"Paid\" || frm.doc.status === \"Unpaid\" || frm.doc.status === \"Submitted\" || frm.doc.status === \"Overdue\") {\n        // SI en el campo de 'cae_factura_electronica' ya se encuentra el dato correspondiente, ocultara el boton\n        // para generar el documento, para luego mostrar el boton para obtener el PDF del documento ya generado.\n        if (frm.doc.cae_factura_electronica) {\n            cur_frm.clear_custom_buttons();\n            pdf_button(frm.doc.cae_factura_electronica, frm);\n            guardar_pdf(frm);\n        } else {\n            // Si la modalidad recibida es manual se genera un boton para hacer la factura electronica manualmente\n            if (modalidad === 'manual') {\n                generar_boton_factura('Factura Electronica', frm);\n            }\n            // Si la modalidad recibida es automatica se realiza la factura electronica directamente\n            if (modalidad === 'automatico') {\n                generar_factura_sin_btn(frm);\n            }\n        }\n    }\n\n    // Codigo para Notas de Credito NCE\n    // El codigo se ejecutara segun el estado del documento, puede ser: Retornar\n    if (frm.doc.status === \"Return\") {\n        //var nombre = 'Nota Credito';\n        // SI en el campo de 'cae_nota_de_credito' ya se encuentra el dato correspondiente, ocultara el boton\n        // para generar el documento, para luego mostrar el boton para obtener el PDF del documento ya generado.\n        if (frm.doc.cae_factura_electronica) {\n            cur_frm.clear_custom_buttons();\n            pdf_button(frm.doc.cae_factura_electronica, frm);\n            guardar_pdf(frm);\n        } else {\n            // Si la modalidad recibida es manual se genera un boton para hacer la factura electronica manualmente\n            if (modalidad === 'manual') {\n                generar_boton_factura('Nota Credito Electronica', frm);\n            }\n            // Si la modalidad recibida es automatica se realiza la factura electronica directamente\n            if (modalidad === 'automatico') {\n                generar_factura_sin_btn(frm);\n            }\n        }\n    }\n\n    // Codigo para notas de debito\n    // Codigo para Notas de Credito NDE\n    if (frm.doc.status === \"Paid\" || frm.doc.status === \"Unpaid\" || frm.doc.status === \"Submitted\" || frm.doc.status === \"Overdue\") {\n        //var nombre = 'Nota Debito';\n        if (frm.doc.es_nota_de_debito) {\n            cur_frm.clear_custom_buttons('Factura Electronica');\n            if (frm.doc.cae_factura_electronica) {\n                cur_frm.clear_custom_buttons();\n                pdf_button(frm.doc.cae_factura_electronica, frm);\n                guardar_pdf(frm);\n            } else {\n                // Si la modalidad recibida es manual se genera un boton para hacer la factura electronica manualmente\n                if (modalidad === 'manual') {\n                    generar_boton_factura('Nota Debito Electronica', frm);\n                }\n                // Si la modalidad recibida es automatica se realiza la factura electronica directamente\n                if (modalidad === 'automatico') {\n                    generar_factura_sin_btn(frm);\n                }\n            }\n        }\n    }\n    /* -------------------------------------------------------------------------------------- */\n    // Funcionalidad evita copiar CAE cuando se duplica una factura\n    if (frm.doc.status === 'Draft') {\n        // console.log('No Guardada');\n        cur_frm.set_value(\"cae_factura_electronica\", '');\n        cur_frm.set_value(\"serie_original_del_documento\", '');\n        // frm.doc.cae_factura_electronica = '';\n        // frm.doc.serie_original_del_documento = '';\n    }\n}\n\nfunction generar_tabla_html(frm) {\n\n    if (frm.doc.items.length > 0) {\n        const mi_array = frm.doc.items;\n        const mi_array_dos = Array.from(mi_array);\n        // console.log(mi_array_dos);\n        frappe.call({\n            method: \"factura_electronica.api.generar_tabla_html\",\n            args: {\n                tabla: JSON.stringify(mi_array_dos)\n            },\n            callback: function (data) {\n                frm.set_value('other_tax_facelec', data.message);\n                frm.refresh_field(\"other_tax_facelec\");\n            }\n        });\n    }\n}\n/* 9 Eventos en Doctypes---------------------------------------------------------------------------------------------- */\n\n/* Factura de Ventas-------------------------------------------------------------------------------------------------- */\nfrappe.ui.form.on(\"Sales Invoice\", {\n    onload_post_render: function (frm, cdt, cdn) {\n        // var section_head = $('.section-head').find(\"a\").filter(function () { return $(this).text() == \"TAX FACELEC\"; }).parent()\n        // section_head.on(\"click\", function () {\n        //     console.log('Hizo click en la seccion');\n        //     generar_tabla_html(frm);\n        // })\n        //console.log('Funcionando Onload Post Render Trigger'); //SI FUNCIONA EL TRIGGER\n        // Funciona unicamente cuando se carga por primera vez el documento y aplica unicamente para el form y no childtables\n\n        // en-US: Enabling event listeners for child tables\n        // es-GT: Habilitando escuchadores de eventos en las tablas hijas del tipo de documento principal\n        // No corra KEY UP, KEY PRESS, KEY DOWN en este campo!   NO NO NO NO NONONO\n        // FIXME FIXME FIXME\n        // Objetivo, cuando se salga del campo mediante TAB, que quede registrado el producto.\n        // estrategia 1:  Focus al campo de quantity?  NO SIRVE.  Como que hay OTRO campo antes, quizas la flechita de link?\n        frm.fields_dict.items.grid.wrapper.on('focusout blur', 'input[data-fieldname=\"item_code\"][data-doctype=\"Sales Invoice Item\"]', function (e) {\n            //console.log(\"Clicked on the field Item Code\");\n\n            each_item(frm, cdt, cdn);\n            facelec_tax_calc_new(frm, cdt, cdn);\n            // facelec_otros_impuestos_fila(frm, cdt, cdn);\n        });\n\n        // FIXME NO FUNCIONA CON TAB, SOLO HACIENDO CLICK Y ENTER.  Si se presiona TAB, SE BORRA!\n\t\t/*frm.fields_dict.items.grid.wrapper.on('blur', 'input[data-fieldname=\"item_code\"][data-doctype=\"Sales Invoice Item\"]', function(e) {\n\t\t\tconsole.log(\"Blurred away from the Item Code Field\");\n\t\t\teach_item(frm, cdt, cdn);\n\t\t\t//facelec_tax_calc_new(frm, cdt, cdn);\n\t\t});*/\n        frm.fields_dict.items.grid.wrapper.on('click', 'input[data-fieldname=\"uom\"][data-doctype=\"Sales Invoice Item\"]', function (e) {\n            //console.log(\"Click on the UOM field\");\n            each_item(frm, cdt, cdn);\n        });\n        frm.fields_dict.items.grid.wrapper.on('blur focusout', 'input[data-fieldname=\"uom\"][data-doctype=\"Sales Invoice Item\"]', function (e) {\n            //console.log(\"Blur or focusout from the UOM field\");\n            each_item(frm, cdt, cdn);\n        });\n        // Do not refresh with each_item in Mouse leave! just recalculate\n        frm.fields_dict.items.grid.wrapper.on('blur', 'input[data-fieldname=\"uom\"][data-doctype=\"Sales Invoice Item\"]', function (e) {\n            //console.log(\"Mouse left the UOM field\");\n            facelec_tax_calc_new(frm, cdt, cdn);\n        });\n        // This part might seem counterintuitive, but it is the \"next\" field in tab order after item code, which helps for a \"creative\" strategy to update everything after pressing TAB out of the item code field.  FIXME\n        frm.fields_dict.items.grid.wrapper.on('blur', 'input[data-fieldname=\"item_name\"][data-doctype=\"Sales Invoice Item\"]', function (e) {\n            //console.log(\"Focusing with keyboard cursor through TAB on the Item Name Field\");\n            each_item(frm, cdt, cdn);\n            facelec_otros_impuestos_fila(frm, cdt, cdn);\n        });\n        frm.fields_dict.items.grid.wrapper.on('blur focusout', 'input[data-fieldname=\"qty\"][data-doctype=\"Sales Invoice Item\"]', function (e) {\n            //console.log(\"Blurring or focusing out from the Quantity Field\");\n            each_item(frm, cdt, cdn);\n        });\n        // Do not refresh with each_item in Mouse leave! just recalculate\n        frm.fields_dict.items.grid.wrapper.on('blur', 'input[data-fieldname=\"qty\"][data-doctype=\"Sales Invoice Item\"]', function (e) {\n            //console.log(\"Mouse leaving from the Quantity Field\");\n            each_item(frm, cdt, cdn);\n            facelec_tax_calc_new(frm, cdt, cdn);\n        });\n        // DO NOT USE Keyup, ??  FIXME FIXME FIXME FIXME FIXME  este hace calculos bien\n        frm.fields_dict.items.grid.wrapper.on('blur focusout', 'input[data-fieldname=\"conversion_factor\"][data-doctype=\"Sales Invoice Item\"]', function (e) {\n            //console.log(\"Blurring or focusing out from the Conversion Factor Field\");\n            //  IMPORTANT! IMPORTANT!  This is the one that gets the calculations correct!\n            // Trying to calc first, then refresh, or no refresh at all...\n            each_item(frm, cdt, cdn);\n            cur_frm.refresh_field(\"conversion_factor\");\n            //facelec_tax_calc_new(frm, cdt, cdn);\n            //setTimeout(function() { facelec_tax_calc_new(frm, cdt, cdn); }, 100);\n            // Running it twice, does not help to clear the variables our when calculating based on new conversion factor. It lags. FIXME\n            //fields_dict.items.wrapper.innerText or FIXME\n            //fields_dict.items.$wrapper.innerText FIXME\n            // find a way to realod this wrapper once more, so that proper data is set with innerHTML. FIXME\n            //setTimeout(function() { facelec_tax_calc_new(frm, cdt, cdn) }, 100);\n        });\n        // This specific one is only for keyup events, to recalculate all. Only on blur will it refresh everything!\n        // Do not refresh with each_item in Mouse leave OR keyup! just recalculate\n        frm.fields_dict.items.grid.wrapper.on('blur focusout', 'input[data-fieldname=\"conversion_factor\"][data-doctype=\"Sales Invoice Item\"]', function (e) {\n            //console.log(\"Key up, mouse leave or focus out from the Conversion Factor Field\");\n            // Trying to calc first, then refresh, or no refresh at all...\n            facelec_tax_calc_new(frm, cdt, cdn);\n            each_item(frm, cdt, cdn);\n            cur_frm.refresh_field(\"conversion_factor\");\n        });\n        frm.fields_dict.items.grid.wrapper.on('blur', 'input[data-fieldname=\"rate\"][data-doctype=\"Sales Invoice Item\"]', function (e) {\n            //console.log(\"Blurring from the Rate Field\");\n            // each_item(frm, cdt, cdn);\n        });\n        // en-US: Enabling event listeners in the main doctype\n        // es-GT: Habilitando escuchadores de eventos en el tipo de documento principal\n        // When ANY key is released after being pressed\n        cur_frm.fields_dict.customer.$input.on(\"blur\", function (evt) {\n            //console.log(\"Se acaba de soltar una tecla del campo customer\");\n            facelec_tax_calc_new(frm, cdt, cdn);\n            each_item(frm, cdt, cdn);\n            refresh_field('qty');\n        });\n        // When mouse leaves the field\n        cur_frm.fields_dict.customer.$input.on(\"blur focusout\", function (evt) {\n            //console.log(\"Salió del campo customercon mouseleave, blur, focusout\");\n            facelec_tax_calc_new(frm, cdt, cdn);\n        });\n        // Mouse clicks over the items field\n        // cur_frm.fields_dict.items.$wrapper.on(\"click\", function (evt) {\n        //     console.log(\"Puntero de Ratón hizo click en el campo Items\");\n        //     each_item(frm, cdt, cdn);\n        // });\n        // Focusout from the field\n        cur_frm.fields_dict.taxes_and_charges.$input.on(\"focusout\", function (evt) {\n            //console.log(\"Campo taxes and charges perdió el enfoque via focusout\");\n            facelec_tax_calc_new(frm, cdt, cdn);\n            facelec_otros_impuestos_fila(frm, cdt, cdn);\n        });\n    },\n    customer: function (frm, cdt, cdn) {\n        // Trigger Proveedor\n    },\n    refresh: function (frm, cdt, cdn) {\n        // Trigger refresh de pagina\n        // es-GT: Obtiene el numero de Identificacion tributaria ingresado en la hoja del cliente.\n        // en-US: Fetches the Taxpayer Identification Number entered in the Customer doctype.\n        cur_frm.add_fetch(\"customer\", \"nit_face_customer\", \"nit_face_customer\");\n\n        // Works OK!\n        frm.add_custom_button(\"UOM Recalculation\", function () {\n            frm.doc.items.forEach((item) => {\n                // for each button press each line is being processed.\n                //console.log(\"item contains: \" + item);\n                //Importante\n                facelec_tax_calc_new(frm, \"Sales Invoice Item\", item.name);\n            });\n        });\n\n        // Cuando el documento se actualiza, la funcion verificac de que exista un cae.\n        // En caso exista un cae, mostrara un boton para ver el PDF de la factura electronica generada.\n        // En caso no exista un cae mostrara el boton para generar la factura electronica\n        // correspondiente a su serie.\n        verificacionCAE('manual', frm, cdt, cdn);\n    },\n    validate: function (frm) {\n        generar_tabla_html(frm);\n    },\n    nit_face_customer: function (frm, cdt, cdn) {\n        // Funcion para validar NIT: Se ejecuta cuando exista un cambio en el campo de NIT\n        valNit(frm.doc.nit_face_customer, frm.doc.customer, frm);\n    },\n    additional_discount_percentage: function (frm, cdt, cdn) {\n        // Pensando en colocar un trigger aqui para cuando se actualice el campo de descuento adicional\n    },\n    discount_amount: function (frm, cdt, cdn) {\n        // Trigger Monto de descuento\n        var tax_before_calc = frm.doc.facelec_total_iva;\n        //console.log(\"El descuento total es:\" + frm.doc.discount_amount);\n        // es-GT: Este muestra el IVA que se calculo por medio de nuestra aplicación.\n        //console.log(\"El IVA calculado anteriormente:\" + frm.doc.facelec_total_iva);\n        var discount_amount_net_value = (frm.doc.discount_amount / (1 + (cur_frm.doc.taxes[0].rate / 100)));\n\n        if (discount_amount_net_value == NaN || discount_amount_net_value == undefined) {\n            //console.log(\"No hay descuento definido, calculando sin descuento.\");\n        } else {\n            //console.log(\"El descuento parece ser un numero definido, calculando con descuento.\");\n            var discount_amount_tax_value = (discount_amount_net_value * (cur_frm.doc.taxes[0].rate / 100));\n            //console.log(\"El IVA del descuento es:\" + discount_amount_tax_value);\n            frm.doc.facelec_total_iva = (frm.doc.facelec_total_iva - discount_amount_tax_value);\n            //console.log(\"El IVA ya sin el iva del descuento es ahora:\" + frm.doc.facelec_total_iva);\n        }\n    },\n    before_save: function (frm, cdt, cdn) {\n        each_item(frm, cdt, cdn);\n        facelec_otros_impuestos_fila(frm, cdt, cdn);\n        // Trigger antes de guardar\n    },\n    on_submit: function (frm, cdt, cdn) {\n        // Ocurre cuando se presione el boton validar.\n        // Cuando se valida el documento, se hace la consulta al servidor por medio de frappe.call\n\n        // Creacion objeto vacio para guardar nombre y valor de las cuentas que se encuentren\n        let cuentas_registradas = {};\n\n        // Recorre la tabla hija en busca de cuentas\n        frm.doc.shs_otros_impuestos.forEach((tax_row, index) => {\n            if (tax_row.account_head) {\n                // Agrega un nuevo valor al objeto (JSON-DICCIONARIO) con el\n                // nombre, valor de la cuenta\n                cuentas_registradas[tax_row.account_head] = tax_row.total;\n            };\n        });\n        // console.log(cuentas_registradas);\n        // console.log(Object.keys(cuentas_registradas).length);\n\n        // Si existe por lo menos una cuenta, se ejecuta frappe.call\n        if (Object.keys(cuentas_registradas).length > 0) {\n            // llama al metodo python, el cual recibe de parametros el nombre de la factura y el objeto\n            // con las ('cuentas encontradas\n            //console.log('---------------------- se encontro por lo menos una cuenta--------------------');\n            frappe.call({\n                method: \"factura_electronica.resources_facelec.special_tax.add_gl_entry_other_special_tax\",\n                args: {\n                    invoice_name: frm.doc.name,\n                    accounts: cuentas_registradas,\n                    invoice_type: \"Sales Invoice\"\n                    /* OJO, El valor de este argumento debe ser \"Sales Invoice\" en sales_invoice.js\n                    En el caso de purchase_invoice.js el valor del argumento debe de ser: invoice_type: \"Purchase Invoice\"\n                    */\n                },\n                // El callback se ejecuta tras finalizar la ejecucion del script python del lado\n                // del servidor\n                callback: function () {\n                    // Busca la modalidad configurada, ya sea Manual o Automatica\n                    // Esto para mostrar u ocultar los botones para la geneneracion de factura\n                    // electronica\n                    frm.reload_doc();\n                    frappe.call({\n                        method: \"factura_electronica.api.obtenerConfiguracionManualAutomatica\",\n                        callback: function (data) {\n                            //console.log(data.message);\n                            if (data.message === 'Manual') {\n                                //console.log('Configuracion encontrada: MANUAL');\n                                // No es necesario tener activa esta parte, ya que cuando se ingresa a cualquier factura en el evento\n                                // refresh, hay una funcion que se encarga de comprobar de que se haya generado exitosamente la\n                                // factura electronica, en caso no sea asi, se mostrarán los botones correspondientes, para hacer\n                                // la generacion de la factura electronica manualmente.\n                                // generarFacturaBTN(frm, cdt, cdn);\n                            }\n                            if (data.message === 'Automatico') {\n                                //console.log('Configuracion encontrada: AUTOMATICO');\n                                // generarFacturaSINBTN(frm, cdt, cdn);\n                                verificacionCAE('automatico', frm, cdt, cdn);\n                            }\n                        }\n                    });\n                }\n            });\n        } else {\n            // Busca la modalidad configurada, ya sea Manual o Automatica\n            // Esto para mostrar u ocultar los botones para la geneneracion de factura\n            // electronica\n            frappe.call({\n                method: \"factura_electronica.api.obtenerConfiguracionManualAutomatica\",\n                callback: function (data) {\n                    //console.log(data.message);\n                    if (data.message === 'Manual') {\n                        //console.log('Configuracion encontrada: MANUAL');\n                        /* No es necesario tener activa esta parte, ya que cuando se ingresa a cualquier factura en el evento\n                        refresh, hay una funcion que se encarga de comprobar de que se haya generado exitosamente la\n                        factura electronica, en caso no sea asi, se mostrarán los botones correspondientes, para hacer\n                        la generacion de la factura electronica manualmente.\n                        generarFacturaBTN(frm, cdt, cdn); */\n                    }\n                    if (data.message === 'Automatico') {\n                        //console.log('Configuracion encontrada: AUTOMATICO');\n                        // generarFacturaSINBTN(frm, cdt, cdn);\n                        verificacionCAE('automatico', frm, cdt, cdn);\n                    }\n                }\n            });\n        }\n    },\n    naming_series: function (frm, cdt, cdn) {\n        frappe.call({\n            method: \"factura_electronica.api.obtener_numero_resolucion\",\n            args: {\n                nombre_serie: frm.doc.naming_series\n            },\n            // El callback se ejecuta tras finalizar la ejecucion del script python del lado\n            // del servidor\n            callback: function (numero_resolucion) {\n                if (numero_resolucion.message === undefined) {\n                    cur_frm.set_value('shs_numero_resolucion', '');\n                } else {\n                    cur_frm.set_value('shs_numero_resolucion', numero_resolucion.message);\n                }\n            }\n        });\n    }\n});\n\nfrappe.ui.form.on(\"Sales Invoice Item\", {\n    items_add: function (frm, cdt, cdn) { },\n    items_move: function (frm, cdt, cdn) { },\n    before_items_remove: function (frm, cdt, cdn) {\n        frm.doc.items.forEach((item_row_1, index_1) => {\n            if (item_row_1.name == cdn) {\n                // console.log('La Fila a Eliminar es --------------> ' + item_row_1.item_code);\n                totalizar_valores(frm, cdn, item_row_1.facelec_tax_rate_per_uom_account, item_row_1.facelec_other_tax_amount)\n                // facelec_tax_calc_new(frm, cdt, cdn);\n            }\n        });\n    },\n    items_remove: function (frm, cdt, cdn) {\n        // es-GT: Este disparador corre al momento de eliminar una nueva fila.\n        // en-US: This trigger runs when removing a row.\n    },\n    item_code: function (frm, cdt, cdn) {\n        each_item(frm, cdt, cdn);\n        //facelec_tax_calc_new(frm, cdt, cdn);\n    },\n    qty: function (frm, cdt, cdn) {\n        //facelec_tax_calculation(frm, cdt, cdn);\n        facelec_tax_calc_new(frm, cdt, cdn);\n        //console.log(\"cdt contains: \" + cdt);\n        //console.log(\"cdn contains: \" + cdn);\n    },\n    uom: function (frm, cdt, cdn) {\n        // Trigger UOM\n        //console.log(\"The unit of measure field was changed and the code from the trigger was run\");\n    },\n    conversion_factor: function (frm, cdt, cdn) {\n        // Trigger factor de conversion\n        //console.log(\"El disparador de factor de conversión se corrió.\");\n        facelec_tax_calc_new(frm, cdt, cdn);\n    },\n    facelec_tax_rate_per_uom_account: function (frm, cdt, cdn) {\n        //facelec_otros_impuestos_fila(frm, cdt,cdn);\n        // esto debe correr aqui?\n    },\n    rate: function (frm, cdt, cdn) {\n        facelec_tax_calc_new(frm, cdt, cdn);\n    },\n    shs_amount_for_back_calc: function (frm, cdt, cdn) {\n        frm.doc.items.forEach((row, index) => {\n            var a = row.rate;\n            var b = row.qty;\n            var c = row.amount;\n\n            //let test = flt(row.shs_amount_for_back_calc) - flt(c);\n            //let testB = test / 2;\n\n            // Usando metodologia GoalSeek.js\n            // https://github.com/adam-hanna/goalSeek.js/blob/master/goalSeek.js\n            // console.log(goalSeek({\n            //     Func: calculo_redondeo_pi,\n            //     aFuncParams: [b, a],\n            //     oFuncArgTarget: {\n            //         Position: 0\n            //     },\n            //     Goal: row.shs_amount_for_back_calc,\n            //     Tol: 0.001,\n            //     maxIter: 10000\n            // }));\n            let calcu = goalSeek({\n                Func: calculo_redondeo_pi,\n                aFuncParams: [b, a],\n                oFuncArgTarget: {\n                    Position: 0\n                },\n                Goal: row.shs_amount_for_back_calc,\n                Tol: 0.001,\n                maxIter: 10000\n            });\n            console.log(calcu);\n\n            frm.doc.items[index].qty = calcu;\n            frm.doc.items[index].stock_qty = calcu;\n            frm.doc.items[index].amount = calcu * frm.doc.items[index].rate;\n            frm.refresh_field(\"items\");\n        });\n    }\n\t/*onload_post_render: function(frm, cdt, cdn){\n\t\tconsole.log('Funcionando Onload Post Render Trigger'); //SI FUNCIONA EL TRIGGER\n\t}*/\n});\n\nfunction calculo_redondeo_pi(a, b) {\n    return a * b;\n}\n/* ----------------------------------------------------------------------------------------------------------------- */","import { valNit } from './facelec.js';\nimport { goalSeek } from './goalSeek.js';\n\n// console.log(\"Hello world from Delivery Note\");\n/* Delivery Note (Nota de entrega) ------------------------------------------------------------------------------------------------------- */\nfunction delivery_note_each_item(frm, cdt, cdn) {\n    frm.doc.items.forEach((item) => {\n        shs_delivery_note_calculation(frm, \"Delivery Note Item\", item.name);\n    });\n}\n\n// Calculos para Nota de Entrega\nfunction shs_delivery_note_calculation(frm, cdt, cdn) {\n    cur_frm.refresh_fields();\n    var this_company_sales_tax_var = cur_frm.doc.taxes[0].rate;\n\n    var this_row_amount = 0;\n    var this_row_stock_qty = 0;\n    var this_row_tax_rate = 0;\n    var this_row_tax_amount = 0;\n    var this_row_taxable_amount = 0;\n\n    frm.doc.items.forEach((item_row, index) => {\n\n        if (item_row.name == cdn) {\n            this_row_amount = (item_row.qty * item_row.rate);\n            this_row_stock_qty = (item_row.qty * item_row.conversion_factor);\n            this_row_tax_rate = (item_row.shs_dn_tax_rate_per_uom);\n            this_row_tax_amount = (this_row_stock_qty * this_row_tax_rate);\n            this_row_taxable_amount = (this_row_amount - this_row_tax_amount);\n\n            frm.doc.items[index].shs_dn_other_tax_amount = ((item_row.shs_dn_tax_rate_per_uom * (item_row.qty * item_row.conversion_factor)));\n            //OJO!  No s epuede utilizar stock_qty en los calculos, debe de ser qty a puro tubo!\n            frm.doc.items[index].shs_dn_amount_minus_excise_tax = ((item_row.qty * item_row.rate) - ((item_row.qty * item_row.conversion_factor) * item_row.shs_dn_tax_rate_per_uom));\n\n            if (item_row.shs_dn_is_fuel) {\n                frm.doc.items[index].shs_dn_gt_tax_net_fuel_amt = (item_row.shs_dn_amount_minus_excise_tax / (1 + (this_company_sales_tax_var / 100)));\n                frm.doc.items[index].shs_dn_sales_tax_for_this_row = (item_row.shs_dn_gt_tax_net_fuel_amt * (this_company_sales_tax_var / 100));\n                // Sumatoria de todos los que tengan el check combustibles\n                let total_fuel = 0;\n                $.each(frm.doc.items || [], function (i, d) {\n                    if (d.shs_dn_is_fuel == true) {\n                        total_fuel += flt(d.shs_dn_gt_tax_net_fuel_amt);\n                    };\n                });\n                frm.doc.shs_dn_gt_tax_fuel = total_fuel;\n            };\n\n            if (item_row.shs_dn_is_good) {\n                frm.doc.items[index].shs_dn_gt_tax_net_goods_amt = (item_row.shs_dn_amount_minus_excise_tax / (1 + (this_company_sales_tax_var / 100)));\n                frm.doc.items[index].shs_dn_sales_tax_for_this_row = (item_row.shs_dn_gt_tax_net_goods_amt * (this_company_sales_tax_var / 100));\n                // Sumatoria de todos los que tengan el check bienes\n                let total_goods = 0;\n                $.each(frm.doc.items || [], function (i, d) {\n                    if (d.shs_dn_is_good == true) {\n                        total_goods += flt(d.shs_dn_gt_tax_net_goods_amt);\n                    };\n                });\n                frm.doc.shs_dn_gt_tax_goods = total_goods;\n            };\n\n            if (item_row.shs_dn_is_service) {\n                frm.doc.items[index].shs_dn_gt_tax_net_services_amt = (item_row.shs_dn_amount_minus_excise_tax / (1 + (this_company_sales_tax_var / 100)));\n                frm.doc.items[index].shs_dn_sales_tax_for_this_row = (item_row.shs_dn_gt_tax_net_services_amt * (this_company_sales_tax_var / 100));\n                // Sumatoria de todos los que tengan el check servicios\n                let total_servi = 0;\n                $.each(frm.doc.items || [], function (i, d) {\n                    if (d.shs_dn_is_service == true) {\n                        total_servi += flt(d.shs_dn_gt_tax_net_services_amt);\n                    };\n                });\n                frm.doc.shs_dn_gt_tax_services = total_servi;\n            };\n\n            let full_tax_iva = 0;\n            $.each(frm.doc.items || [], function (i, d) {\n                full_tax_iva += flt(d.shs_dn_sales_tax_for_this_row);\n            });\n            frm.doc.shs_dn_total_iva = full_tax_iva;\n        };\n    });\n}\n\nfrappe.ui.form.on(\"Delivery Note\", {\n    onload_post_render: function (frm, cdt, cdn) {\n        // en-US: Enabling event listeners for child tables\n        // es-GT: Habilitando escuchadores de eventos en las tablas hijas del tipo de documento principal\n        frm.fields_dict.items.grid.wrapper.on('click focusout blur', 'input[data-fieldname=\"item_code\"][data-doctype=\"Delivery Note Item\"]', function (e) {\n            shs_delivery_note_calculation(frm, cdt, cdn);\n            delivery_note_each_item(frm, cdt, cdn);\n        });\n\n        frm.fields_dict.items.grid.wrapper.on('click', 'input[data-fieldname=\"uom\"][data-doctype=\"Delivery Note Item\"]', function (e) {\n            delivery_note_each_item(frm, cdt, cdn);\n        });\n\n        frm.fields_dict.items.grid.wrapper.on('blur focusout', 'input[data-fieldname=\"uom\"][data-doctype=\"Delivery Note Item\"]', function (e) {\n            delivery_note_each_item(frm, cdt, cdn);\n        });\n\n        // Do not refresh with each_item in Mouse leave! just recalculate\n        frm.fields_dict.items.grid.wrapper.on('mouseleave', 'input[data-fieldname=\"uom\"][data-doctype=\"Delivery Note Item\"]', function (e) {\n            shs_delivery_note_calculation(frm, cdt, cdn);\n        });\n\n        // This part might seem counterintuitive, but it is the \"next\" field in tab order after item code, which helps for a \"creative\" strategy to update everything after pressing TAB out of the item code field.  FIXME\n        frm.fields_dict.items.grid.wrapper.on('focus', 'input[data-fieldname=\"item_name\"][data-doctype=\"Delivery Note Item\"]', function (e) {\n            delivery_note_each_item(frm, cdt, cdn);\n        });\n\n        frm.fields_dict.items.grid.wrapper.on('blur focusout', 'input[data-fieldname=\"qty\"][data-doctype=\"Delivery Note Item\"]', function (e) {\n            delivery_note_each_item(frm, cdt, cdn);\n        });\n\n        // Do not refresh with each_item in Mouse leave! just recalculate\n        frm.fields_dict.items.grid.wrapper.on('mouseleave', 'input[data-fieldname=\"qty\"][data-doctype=\"Delivery Note Item\"]', function (e) {\n            delivery_note_each_item(frm, cdt, cdn);\n            shs_delivery_note_calculation(frm, cdt, cdn);\n        });\n\n        // DO NOT USE Keyup, ??  FIXME FIXME FIXME FIXME FIXME  este hace calculos bien\n        frm.fields_dict.items.grid.wrapper.on('blur focusout', 'input[data-fieldname=\"conversion_factor\"][data-doctype=\"Delivery Note Item\"]', function (e) {\n            //  IMPORTANT! IMPORTANT!  This is the one that gets the calculations correct!\n            // Trying to calc first, then refresh, or no refresh at all...\n            delivery_note_each_item(frm, cdt, cdn);\n            cur_frm.refresh_field(\"conversion_factor\");\n        });\n\n        // This specific one is only for keyup events, to recalculate all. Only on blur will it refresh everything!\n        // Do not refresh with each_item in Mouse leave OR keyup! just recalculate\n        frm.fields_dict.items.grid.wrapper.on('keyup mouseleave focusout', 'input[data-fieldname=\"conversion_factor\"][data-doctype=\"Delivery Note Item\"]', function (e) {\n            // Trying to calc first, then refresh, or no refresh at all...\n            shs_delivery_note_calculation(frm, cdt, cdn);\n            delivery_note_each_item(frm, cdt, cdn);\n            cur_frm.refresh_field(\"conversion_factor\");\n        });\n\n        // en-US: Enabling event listeners in the main doctype\n        // es-GT: Habilitando escuchadores de eventos en el tipo de documento principal\n        // When ANY key is released after being pressed\n        // cur_frm.fields_dict.customer.$input.on(\"keyup\", function (evt) {\n        //     shs_delivery_note_calculation(frm, cdt, cdn);\n        //     delivery_note_each_item(frm, cdt, cdn);\n        //     refresh_field('qty');\n        // });\n\n        // When mouse leaves the field\n        cur_frm.fields_dict.customer.$input.on(\"mouseleave blur focusout\", function (evt) {\n            shs_delivery_note_calculation(frm, cdt, cdn);\n        });\n\n        // Mouse clicks over the items field\n        cur_frm.fields_dict.items.$wrapper.on(\"click\", function (evt) {\n            delivery_note_each_item(frm, cdt, cdn);\n        });\n\n        // Focusout from the field\n        cur_frm.fields_dict.taxes_and_charges.$input.on(\"focusout\", function (evt) {\n            shs_delivery_note_calculation(frm, cdt, cdn);\n        });\n    },\n    shs_dn_nit: function (frm) {\n        // Funcion para validar NIT: Se ejecuta cuando exista un cambio en el campo de NIT\n        valNit(frm.doc.shs_dn_nit, frm.doc.customer, frm);\n    },\n    discount_amount: function (frm) {\n        // Trigger Monto de descuento\n        var tax_before_calc = frm.doc.shs_dn_total_iva;\n        // es-GT: Este muestra el IVA que se calculo por medio de nuestra aplicación.\n        var discount_amount_net_value = (frm.doc.discount_amount / (1 + (cur_frm.doc.taxes[0].rate / 100)));\n\n        if (discount_amount_net_value == NaN || discount_amount_net_value == undefined) {\n        } else {\n            discount_amount_tax_value = (discount_amount_net_value * (cur_frm.doc.taxes[0].rate / 100));\n            frm.doc.shs_dn_total_iva = (frm.doc.shs_dn_total_iva - discount_amount_tax_value);\n        }\n    },\n    before_save: function (frm, cdt, cdn) {\n        delivery_note_each_item(frm, cdt, cdn);\n    },\n});\n\nfrappe.ui.form.on(\"Delivery Note Item\", {\n    items_remove: function (frm) {\n        // es-GT: Este disparador corre al momento de eliminar una nueva fila.\n        // en-US: This trigger runs when removing a row.\n        // Vuelve a calcular los totales de FUEL, GOODS, SERVICES e IVA cuando se elimina una fila.\n\n        var fix_gt_tax_fuel = 0;\n        var fix_gt_tax_goods = 0;\n        var fix_gt_tax_services = 0;\n        var fix_gt_tax_iva = 0;\n\n        $.each(frm.doc.items || [], function (i, d) {\n            fix_gt_tax_fuel += flt(d.shs_dn_gt_tax_net_fuel_amt);\n            fix_gt_tax_goods += flt(d.shs_dn_gt_tax_net_goods_amt);\n            fix_gt_tax_services += flt(d.shs_dn_gt_tax_net_services_amt);\n            fix_gt_tax_iva += flt(d.shs_dn_sales_tax_for_this_row);\n        });\n\n        cur_frm.set_value(\"shs_dn_gt_tax_fuel\", fix_gt_tax_fuel);\n        cur_frm.set_value(\"shs_dn_gt_tax_goods\", fix_gt_tax_goods);\n        cur_frm.set_value(\"shs_dn_gt_tax_services\", fix_gt_tax_services);\n        cur_frm.set_value(\"shs_dn_total_iva\", fix_gt_tax_iva);\n    },\n    item_code: function (frm, cdt, cdn) {\n        // Trigger codigo de producto\n        refresh_field('qty');\n    },\n    qty: function (frm, cdt, cdn) {\n        // Trigger cantidad\n        shs_delivery_note_calculation(frm, cdt, cdn);\n    },\n    conversion_factor: function (frm, cdt, cdn) {\n        // Trigger factor de conversion\n        shs_delivery_note_calculation(frm, cdt, cdn);\n    },\n    rate: function (frm, cdt, cdn) {\n        shs_delivery_note_calculation(frm, cdt, cdn);\n    },\n    shs_amount_for_back_calc: function (frm, cdt, cdn) {\n        frm.doc.items.forEach((row, index) => {\n            var a = row.rate;\n            var b = row.qty;\n            var c = row.amount;\n\n            //let test = flt(row.shs_amount_for_back_calc) - flt(c);\n            //let testB = test / 2;\n\n            // Usando metodologia GoalSeek.js\n            // https://github.com/adam-hanna/goalSeek.js/blob/master/goalSeek.js\n            // console.log(goalSeek({\n            //     Func: calculo_redondeo_pi,\n            //     aFuncParams: [b, a],\n            //     oFuncArgTarget: {\n            //         Position: 0\n            //     },\n            //     Goal: row.shs_amount_for_back_calc,\n            //     Tol: 0.001,\n            //     maxIter: 10000\n            // }));\n            let calcu = goalSeek({\n                Func: redondeo_delivery_note,\n                aFuncParams: [b, a],\n                oFuncArgTarget: {\n                    Position: 0\n                },\n                Goal: row.shs_amount_for_back_calc,\n                Tol: 0.001,\n                maxIter: 10000\n            });\n            console.log(calcu);\n\n            frm.doc.items[index].qty = calcu;\n            frm.doc.items[index].stock_qty = calcu;\n            frm.doc.items[index].amount = calcu * frm.doc.items[index].rate;\n            frm.refresh_field(\"items\");\n        });\n    }\n});\n\nfunction redondeo_delivery_note(a, b) {\n    return a * b;\n}\n/* ----------------------------------------------------------------------------------------------------------------- */","import { valNit } from './facelec.js';\n\n// console.log(\"Hello world from Sales Order\");\n\n/* Sales Order (Orden de Venta) ------------------------------------------------------------------------------------------------------- */\nfunction sales_order_each_item(frm, cdt, cdn) {\n    frm.doc.items.forEach((item) => {\n        shs_sales_order_calculation(frm, \"Sales Order Item\", item.name);\n    });\n}\n\n// Calculos para Orden de Venta\nfunction shs_sales_order_calculation(frm, cdt, cdn) {\n    cur_frm.refresh_fields();\n    var this_company_sales_tax_var = cur_frm.doc.taxes[0].rate;\n\n    var this_row_amount = 0;\n    var this_row_stock_qty = 0;\n    var this_row_tax_rate = 0;\n    var this_row_tax_amount = 0;\n    var this_row_taxable_amount = 0;\n\n    frm.doc.items.forEach((item_row, index) => {\n\n        if (item_row.name == cdn) {\n            this_row_amount = (item_row.qty * item_row.rate);\n            this_row_stock_qty = (item_row.qty * item_row.conversion_factor);\n            this_row_tax_rate = (item_row.shs_so_tax_rate_per_uom);\n            this_row_tax_amount = (this_row_stock_qty * this_row_tax_rate);\n            this_row_taxable_amount = (this_row_amount - this_row_tax_amount);\n\n            frm.doc.items[index].shs_so_other_tax_amount = ((item_row.shs_so_tax_rate_per_uom * (item_row.qty * item_row.conversion_factor)));\n            //OJO!  No s epuede utilizar stock_qty en los calculos, debe de ser qty a puro tubo!\n            frm.doc.items[index].shs_so_amount_minus_excise_tax = ((item_row.qty * item_row.rate) - ((item_row.qty * item_row.conversion_factor) * item_row.shs_so_tax_rate_per_uom));\n\n            if (item_row.shs_so_is_fuel) {\n                frm.doc.items[index].shs_so_gt_tax_net_fuel_amt = (item_row.shs_so_amount_minus_excise_tax / (1 + (this_company_sales_tax_var / 100)));\n                frm.doc.items[index].shs_so_sales_tax_for_this_row = (item_row.shs_so_gt_tax_net_fuel_amt * (this_company_sales_tax_var / 100));\n                // Sumatoria de todos los que tengan el check combustibles\n                let total_fuel = 0;\n                $.each(frm.doc.items || [], function (i, d) {\n                    if (d.shs_so_is_fuel == true) {\n                        total_fuel += flt(d.shs_so_gt_tax_net_fuel_amt);\n                    };\n                });\n                frm.doc.shs_gt_tax_fuel = total_fuel;\n            };\n\n            if (item_row.shs_so_is_good) {\n                frm.doc.items[index].shs_so_gt_tax_net_goods_amt = (item_row.shs_so_amount_minus_excise_tax / (1 + (this_company_sales_tax_var / 100)));\n                frm.doc.items[index].shs_so_sales_tax_for_this_row = (item_row.shs_so_gt_tax_net_goods_amt * (this_company_sales_tax_var / 100));\n                // Sumatoria de todos los que tengan el check bienes\n                let total_goods = 0;\n                $.each(frm.doc.items || [], function (i, d) {\n                    if (d.shs_so_is_good == true) {\n                        total_goods += flt(d.shs_so_gt_tax_net_goods_amt);\n                    };\n                });\n                frm.doc.shs_so_gt_tax_goods = total_goods;\n            };\n\n            if (item_row.shs_so_is_service) {\n                frm.doc.items[index].shs_so_gt_tax_net_services_amt = (item_row.shs_so_amount_minus_excise_tax / (1 + (this_company_sales_tax_var / 100)));\n                frm.doc.items[index].shs_so_sales_tax_for_this_row = (item_row.shs_so_gt_tax_net_services_amt * (this_company_sales_tax_var / 100));\n                // Sumatoria de todos los que tengan el check servicios\n                let total_servi = 0;\n                $.each(frm.doc.items || [], function (i, d) {\n                    if (d.shs_so_is_service == true) {\n                        total_servi += flt(d.shs_so_gt_tax_net_services_amt);\n                    };\n                });\n                frm.doc.shs_so_gt_tax_services = total_servi;\n            };\n\n            let full_tax_iva = 0;\n            $.each(frm.doc.items || [], function (i, d) {\n                full_tax_iva += flt(d.shs_so_sales_tax_for_this_row);\n            });\n            frm.doc.shs_so_total_iva = full_tax_iva;\n        };\n    });\n}\n\nfrappe.ui.form.on(\"Sales Order\", {\n    onload_post_render: function (frm, cdt, cdn) {\n        // en-US: Enabling event listeners for child tables\n        // es-GT: Habilitando escuchadores de eventos en las tablas hijas del tipo de documento principal\n        frm.fields_dict.items.grid.wrapper.on('click focusout blur', 'input[data-fieldname=\"item_code\"][data-doctype=\"Sales Order Item\"]', function (e) {\n            shs_sales_order_calculation(frm, cdt, cdn);\n            sales_order_each_item(frm, cdt, cdn);\n        });\n\n        frm.fields_dict.items.grid.wrapper.on('click', 'input[data-fieldname=\"uom\"][data-doctype=\"Sales Order Item\"]', function (e) {\n            sales_order_each_item(frm, cdt, cdn);\n        });\n\n        frm.fields_dict.items.grid.wrapper.on('blur focusout', 'input[data-fieldname=\"uom\"][data-doctype=\"Sales Order Item\"]', function (e) {\n            sales_order_each_item(frm, cdt, cdn);\n        });\n\n        // Do not refresh with each_item in Mouse leave! just recalculate\n        frm.fields_dict.items.grid.wrapper.on('mouseleave', 'input[data-fieldname=\"uom\"][data-doctype=\"Sales Order Item\"]', function (e) {\n            shs_sales_order_calculation(frm, cdt, cdn);\n        });\n\n        // This part might seem counterintuitive, but it is the \"next\" field in tab order after item code, which helps for a \"creative\" strategy to update everything after pressing TAB out of the item code field.  FIXME\n        frm.fields_dict.items.grid.wrapper.on('focus', 'input[data-fieldname=\"item_name\"][data-doctype=\"Sales Order Item\"]', function (e) {\n            sales_order_each_item(frm, cdt, cdn);\n        });\n\n        frm.fields_dict.items.grid.wrapper.on('blur focusout', 'input[data-fieldname=\"qty\"][data-doctype=\"Sales Order Item\"]', function (e) {\n            sales_order_each_item(frm, cdt, cdn);\n        });\n\n        // Do not refresh with each_item in Mouse leave! just recalculate\n        frm.fields_dict.items.grid.wrapper.on('mouseleave', 'input[data-fieldname=\"qty\"][data-doctype=\"Sales Order Item\"]', function (e) {\n            sales_order_each_item(frm, cdt, cdn);\n            shs_sales_order_calculation(frm, cdt, cdn);\n        });\n\n        // DO NOT USE Keyup, ??  FIXME FIXME FIXME FIXME FIXME  este hace calculos bien\n        frm.fields_dict.items.grid.wrapper.on('blur focusout', 'input[data-fieldname=\"conversion_factor\"][data-doctype=\"Sales Order Item\"]', function (e) {\n            //  IMPORTANT! IMPORTANT!  This is the one that gets the calculations correct!\n            // Trying to calc first, then refresh, or no refresh at all...\n            sales_order_each_item(frm, cdt, cdn);\n            cur_frm.refresh_field(\"conversion_factor\");\n        });\n\n        // This specific one is only for keyup events, to recalculate all. Only on blur will it refresh everything!\n        // Do not refresh with each_item in Mouse leave OR keyup! just recalculate\n        frm.fields_dict.items.grid.wrapper.on('keyup mouseleave focusout', 'input[data-fieldname=\"conversion_factor\"][data-doctype=\"Sales Order Item\"]', function (e) {\n            // Trying to calc first, then refresh, or no refresh at all...\n            shs_sales_order_calculation(frm, cdt, cdn);\n            sales_order_each_item(frm, cdt, cdn);\n            cur_frm.refresh_field(\"conversion_factor\");\n        });\n\n        // en-US: Enabling event listeners in the main doctype\n        // es-GT: Habilitando escuchadores de eventos en el tipo de documento principal\n        // When ANY key is released after being pressed\n        cur_frm.fields_dict.customer.$input.on(\"keyup\", function (evt) {\n            // shs_sales_order_calculation(frm, cdt, cdn);\n            // sales_order_each_item(frm, cdt, cdn);\n            // refresh_field('qty');\n        });\n\n        // When mouse leaves the field\n        cur_frm.fields_dict.customer.$input.on(\"blur focusout\", function (evt) {\n            shs_sales_order_calculation(frm, cdt, cdn);\n        });\n\n        // Mouse clicks over the items field\n        cur_frm.fields_dict.items.$wrapper.on(\"click\", function (evt) {\n            sales_order_each_item(frm, cdt, cdn);\n        });\n\n        // Focusout from the field\n        cur_frm.fields_dict.taxes_and_charges.$input.on(\"focusout\", function (evt) {\n            shs_sales_order_calculation(frm, cdt, cdn);\n        });\n    },\n    shs_so_nit: function (frm) {\n        // Funcion para validar NIT: Se ejecuta cuando exista un cambio en el campo de NIT\n        valNit(frm.doc.shs_so_nit, frm.doc.customer, frm);\n    },\n    discount_amount: function (frm) {\n        // Trigger Monto de descuento\n        var tax_before_calc = frm.doc.shs_so_total_iva;\n        // es-GT: Este muestra el IVA que se calculo por medio de nuestra aplicación.\n        var discount_amount_net_value = (frm.doc.discount_amount / (1 + (cur_frm.doc.taxes[0].rate / 100)));\n\n        if (discount_amount_net_value == NaN || discount_amount_net_value == undefined) {\n        } else {\n            discount_amount_tax_value = (discount_amount_net_value * (cur_frm.doc.taxes[0].rate / 100));\n            frm.doc.shs_so_total_iva = (frm.doc.shs_so_total_iva - discount_amount_tax_value);\n        }\n    },\n    before_save: function (frm, cdt, cdn) {\n        sales_order_each_item(frm, cdt, cdn);\n    },\n});\n\nfrappe.ui.form.on(\"Sales Order Item\", {\n    items_remove: function (frm) {\n        // es-GT: Este disparador corre al momento de eliminar una nueva fila.\n        // en-US: This trigger runs when removing a row.\n        // Vuelve a calcular los totales de FUEL, GOODS, SERVICES e IVA cuando se elimina una fila.\n\n        var fix_gt_tax_fuel = 0;\n        var fix_gt_tax_goods = 0;\n        var fix_gt_tax_services = 0;\n        var fix_gt_tax_iva = 0;\n\n        $.each(frm.doc.items || [], function (i, d) {\n            fix_gt_tax_fuel += flt(d.shs_so_gt_tax_net_fuel_amt);\n            fix_gt_tax_goods += flt(d.shs_so_gt_tax_net_goods_amt);\n            fix_gt_tax_services += flt(d.shs_so_gt_tax_net_services_amt);\n            fix_gt_tax_iva += flt(d.shs_so_sales_tax_for_this_row);\n        });\n\n        cur_frm.set_value(\"shs_gt_tax_fuel\", fix_gt_tax_fuel);\n        cur_frm.set_value(\"shs_so_gt_tax_goods\", fix_gt_tax_goods);\n        cur_frm.set_value(\"shs_so_gt_tax_services\", fix_gt_tax_services);\n        cur_frm.set_value(\"shs_so_total_iva\", fix_gt_tax_iva);\n    },\n    item_code: function (frm, cdt, cdn) {\n        // Trigger codigo de producto\n        var this_company_sales_tax_var = cur_frm.doc.taxes[0].rate;\n        refresh_field('qty');\n    },\n    qty: function (frm, cdt, cdn) {\n        // Trigger cantidad\n        shs_sales_order_calculation(frm, cdt, cdn);\n    },\n    conversion_factor: function (frm, cdt, cdn) {\n        // Trigger factor de conversion\n        shs_sales_order_calculation(frm, cdt, cdn);\n    },\n    rate: function (frm, cdt, cdn) {\n        shs_sales_order_calculation(frm, cdt, cdn);\n    }\n});\n\n/* ----------------------------------------------------------------------------------------------------------------- */","import { valNit } from './facelec.js';\n\n//console.log(\"Hello world from Quotation\");\n\n/* Sales Quotation (Cotizacion) ------------------------------------------------------------------------------------------------------- */\nfunction quotation_each_item(frm, cdt, cdn) {\n    frm.doc.items.forEach((item) => {\n        shs_quotation_calculation(frm, \"Quotation Item\", item.name);\n        coti_insertar_fila_otro_impuesto(frm, \"Quotation Item\", item.name);\n    });\n}\n\n/**\n* Parametros:\n* #1 frm = formulario que se esta trabajando\n* #2 tax_account = nombre de la cuenta\n*\n* Funcionamiento:\n* Recorre la tabla items, por cada item que encuentre con el nombre de\n* cuenta recibido, lo ira concatenando en una variable que al finalizar\n* el recorrido de la tabla lo retornara a quien haya invocado la fucnion\n*/\nfunction coti_sumatoria_por_cuenta_items(frm, tax_account) {\n    var total_sumatoria = 0;\n\n    $.each(frm.doc.items || [], function (i, d) {\n        if (d.facelec_qt_tax_rate_per_uom_account === tax_account) {\n            total_sumatoria += flt(d.facelec_qt_other_tax_amount);\n        };\n    });\n\n    return total_sumatoria;\n}\n\n/**\n* Parametros:\n* #1 frm = formulario que se esta trabajando\n* #2 cdt = Doctype\n* #3 cdn = Docname\n*\n* Funcionamiento:\n* Recorre la tabla items, por cada item encontrado, si tiene una cuenta asignada,\n* recorrera la tabla hija shs_tax_quotation en busca de items con el mismo nombre\n* de cuenta anteriormente encontrado, para totalizar el valor del impuestos, para todos\n* los items con la misma cuenta.\n*/\nfunction coti_sumatoria_otros_impuestos_por_cuenta(frm, cdt, cdn) {\n    frm.doc.items.forEach((item_row_1, index_1) => {\n        if (item_row_1.name === cdn) {\n            if (item_row_1.facelec_qt_tax_rate_per_uom_account) {\n\n                frm.doc.shs_tax_quotation.forEach((tax_row_2, index_2) => {\n\n                    if (tax_row_2.account_head === item_row_1.facelec_qt_tax_rate_per_uom_account) {\n                        var totalizador = 0;\n                        totalizador = coti_sumatoria_por_cuenta_items(frm, tax_row_2.account_head)\n                        cur_frm.doc.shs_tax_quotation[index_2].total = totalizador;\n                        coti_total_de_otros_impuestos(frm);\n                    }\n\n                });\n\n            }\n        }\n    });\n}\n\n/**\n* Parametros:\n* #1 frm = formulario que se esta trabajando\n*\n* Funcionamiento:\n* Recorre la tabla hija shs_tax_quotation, realiza sumatoria de todos las filas\n* que tenga una cuenta, el valor totalizado se asigna al campo shs_total_otros_imp_incl\n*/\nfunction coti_total_de_otros_impuestos(frm) {\n    var total_tax = 0;\n\n    $.each(frm.doc.shs_tax_quotation || [], function (i, d) {\n        if (d.account_head) {\n            total_tax += flt(d.total);\n        };\n    });\n\n    cur_frm.set_value('shs_qt_total_otros_imp_incl', total_tax);\n    frm.refresh_field(\"shs_qt_total_otros_imp_incl\");\n}\n\n/**\n* Parametros:\n* #1 frm = formulario que se esta trabajando\n* #2 cdt = Doctype\n* #3 cdn = Docname\n*\n* Funcionamiento:\n* Recorre la tabla items, por cada fila con una cuenta asignada buscara en la tabla hija\n* shs_tax_quotation por una fila con el mismo nombre de la cuenta anteriormente encontrada,\n* si no la encuentra en shs_tax_quotation creara una nueva fila, y le asignara los valores\n* de nombre de cuenta y el total para esa cuenta. Si la cuenta ya se encuentra creada en\n* shs_tax_quotation le sumara los valores encontrados.\n*/\nfunction coti_insertar_fila_otro_impuesto(frm, cdt, cdn) {\n    var shs_otro_impuesto = 0;\n\n    frm.doc.items.forEach((item_row_i, indice) => {\n        if (item_row_i.name === cdn) {\n            shs_otro_impuesto = item_row_i.facelec_qt_other_tax_amount;\n\n            // Guarda el nombre de la cuenta del item seleccionado\n            var cuenta = item_row_i.facelec_qt_tax_rate_per_uom_account;\n            // console.log('Cuenta de item encontrada es : ' + cuenta);\n\n            frm.refresh_field('items');\n            frm.refresh_field('conversion_factor');\n\n            if (cuenta) { // Si encuentra una cuenta con nombre procede\n                if (!(coti_buscar_cuenta(frm, cuenta))) { // Si no encuentra una cuenta, procede.\n\n                    frappe.model.add_child(cur_frm.doc, \"Otros Impuestos Factura Electronica\", \"shs_tax_quotation\");\n                    // Refresh datos de la tabla hija items\n                    cur_frm.refresh_field('items');\n                    // Recorre la tabla hija 'taxes' en busca de la nueva fila que se agrego anteriormente donde account_head\n                    // sea undefined\n                    frm.doc.shs_tax_quotation.forEach((tax_row, index) => {\n\n                        // Si encuentra la fila anteriormente agregada procede\n                        if (tax_row.account_head === undefined) {\n                            // Asigna valores en la fila recien creada\n                            cur_frm.doc.shs_tax_quotation[index].account_head = cuenta;\n                            cur_frm.doc.shs_tax_quotation[index].total = shs_otro_impuesto;\n                            // Actualiza los datos de la tabla hija\n                            cur_frm.refresh_field(\"shs_tax_quotation\");\n                            // Funcion que se encarda de sumar los valores por cuenta\n                            coti_sumatoria_otros_impuestos_por_cuenta(frm, cdt, cdn);\n                            cur_frm.refresh_field(\"shs_tax_quotation\");\n                        }\n\n                    });\n\n                } else { // Si la cuenta ya esta agregada en shs_tax_quotation, se procede a sumar sobre los valores\n                    // ya existentes\n                    // Funcion que se encarda de sumar los valores por cuenta\n                    coti_sumatoria_otros_impuestos_por_cuenta(frm, cdt, cdn);\n                    cur_frm.refresh_field(\"shs_tax_quotation\");\n                }\n            }\n        }\n    });\n\n}\n\n/**\n* Se encarga de recalcular el total de otros impuestos cuando se elimina un item\n*/\nfunction coti_total_otros_impuestos_eliminacion(frm, tax_account_n, otro_impuesto) {\n    // Recorre items\n    frm.doc.items.forEach((item_row, i1) => {\n        if (item_row.facelec_qt_tax_rate_per_uom_account === tax_account_n) {\n            var total = (coti_sumatoria_por_cuenta_items(frm, tax_account_n) - otro_impuesto);\n            // recorre shs_tax_quotation\n            frm.doc.shs_tax_quotation.forEach((tax_row, i2) => {\n                if (tax_row.account_head === tax_account_n) {\n                    cur_frm.doc.shs_tax_quotation[i2].total = total;\n                    cur_frm.refresh_field(\"shs_tax_quotation\");\n                    coti_total_de_otros_impuestos(frm);\n                    cur_frm.refresh_field(\"shs_tax_quotation\");\n\n                    if (tax_row.total === 0) {\n                        // Elimina la fila con valor 0\n                        cur_frm.doc.shs_tax_quotation.splice(cur_frm.doc.shs_tax_quotation[i2], 1);\n                        cur_frm.refresh_field(\"shs_tax_quotation\");\n                    }\n                }\n            });\n        }\n    });\n\n}\n\n/**\n* Funcionamiento: recibe como parametro frm, y cuenta_b, lo que hace es, buscar en todas las filas de taxes\n* si existe ya una cuenta con el nombre de la cuenta recibida por parametro, en caso ya exista esa cuenta en\n* la tabla no hace nada, pero si encuentra que no hay una cuenta igual a la recibida en el parametro, entonces\n* la funcion encargada agregara una nueva fila con los datos correspondientes, esta funcion retorna true\n* en caso si encuentre una cuenta existente\n*/\nfunction coti_buscar_cuenta(frm, cuenta_b) {\n\n    var estado = false;\n\n    $.each(frm.doc.shs_tax_quotation || [], function (i, d) {\n        if (d.account_head === cuenta_b) {\n            estado = true;\n        }\n    });\n\n    return estado;\n}\n\n// Calculos para Factura de Compra\nfunction shs_quotation_calculation(frm, cdt, cdn) {\n    cur_frm.refresh_fields();\n    var this_company_sales_tax_var = cur_frm.doc.taxes[0].rate;\n\n    var this_row_amount = 0;\n    var this_row_stock_qty = 0;\n    var this_row_tax_rate = 0;\n    var this_row_tax_amount = 0;\n    var this_row_taxable_amount = 0;\n\n    frm.doc.items.forEach((item_row, index) => {\n\n        if (item_row.name == cdn) {\n            this_row_amount = (item_row.qty * item_row.rate);\n            this_row_stock_qty = (item_row.qty * item_row.conversion_factor);\n            this_row_tax_rate = (item_row.facelec_qt_tax_rate_per_uom);\n            this_row_tax_amount = (this_row_stock_qty * this_row_tax_rate);\n            this_row_taxable_amount = (this_row_amount - this_row_tax_amount);\n\n            frm.doc.items[index].facelec_qt_other_tax_amount = ((item_row.facelec_qt_tax_rate_per_uom * (item_row.qty * item_row.conversion_factor)));\n            //OJO!  No s epuede utilizar stock_qty en los calculos, debe de ser qty a puro tubo!\n            frm.doc.items[index].facelec_qt_amount_minus_excise_tax = ((item_row.qty * item_row.rate) - ((item_row.qty * item_row.conversion_factor) * item_row.facelec_qt_tax_rate_per_uom));\n\n            if (item_row.facelec_qt_is_fuel) {\n                frm.doc.items[index].facelec_qt_gt_tax_net_fuel_amt = (item_row.facelec_qt_amount_minus_excise_tax / (1 + (this_company_sales_tax_var / 100)));\n                frm.doc.items[index].facelec_qt_sales_tax_for_this_row = (item_row.facelec_qt_gt_tax_net_fuel_amt * (this_company_sales_tax_var / 100));\n                // Sumatoria de todos los que tengan el check combustibles\n                let total_fuel = 0;\n                $.each(frm.doc.items || [], function (i, d) {\n                    if (d.facelec_qt_is_fuel == true) {\n                        total_fuel += flt(d.facelec_qt_gt_tax_net_fuel_amt);\n                    };\n                });\n                frm.doc.facelec_qt_gt_tax_fuel = total_fuel;\n            };\n\n            if (item_row.facelec_qt_is_good) {\n                frm.doc.items[index].facelec_qt_gt_tax_net_goods_amt = (item_row.facelec_qt_amount_minus_excise_tax / (1 + (this_company_sales_tax_var / 100)));\n                frm.doc.items[index].facelec_qt_sales_tax_for_this_row = (item_row.facelec_qt_gt_tax_net_goods_amt * (this_company_sales_tax_var / 100));\n                // Sumatoria de todos los que tengan el check bienes\n                let total_goods = 0;\n                $.each(frm.doc.items || [], function (i, d) {\n                    if (d.facelec_qt_is_good == true) {\n                        total_goods += flt(d.facelec_qt_gt_tax_net_goods_amt);\n                    };\n                });\n                frm.doc.facelec_qt_gt_tax_goods = total_goods;\n            };\n\n            if (item_row.facelec_qt_is_service == 1) {\n                frm.doc.items[index].facelec_qt_gt_tax_net_services_amt = (item_row.facelec_qt_amount_minus_excise_tax / (1 + (this_company_sales_tax_var / 100)));\n                frm.doc.items[index].facelec_qt_sales_tax_for_this_row = (item_row.facelec_qt_gt_tax_net_services_amt * (this_company_sales_tax_var / 100));\n                // Sumatoria de todos los que tengan el check servicios\n                let total_servi = 0;\n                $.each(frm.doc.items || [], function (i, d) {\n                    if (d.facelec_qt_is_service == true) {\n                        total_servi += flt(d.facelec_qt_gt_tax_net_services_amt);\n                    };\n                });\n                frm.doc.facelec_qt_gt_tax_services = total_servi;\n            };\n\n            let full_tax_iva = 0;\n            $.each(frm.doc.items || [], function (i, d) {\n                full_tax_iva += flt(d.facelec_qt_sales_tax_for_this_row);\n            });\n            frm.doc.facelec_qt_total_iva = full_tax_iva;\n        };\n    });\n}\n\nfrappe.ui.form.on(\"Quotation\", {\n    onload_post_render: function (frm, cdt, cdn) {\n        // Funciona unicamente cuando se carga por primera vez el documento y aplica unicamente para el form y no childtables\n\n        // en-US: Enabling event listeners for child tables\n        // es-GT: Habilitando escuchadores de eventos en las tablas hijas del tipo de documento principal\n        // No corra KEY UP, KEY PRESS, KEY DOWN en este campo!   NO NO NO NO NONONO\n        frm.fields_dict.items.grid.wrapper.on('click focusout blur', 'input[data-fieldname=\"item_code\"][data-doctype=\"Quotation Item\"]', function (e) {\n            shs_quotation_calculation(frm, cdt, cdn);\n            quotation_each_item(frm, cdt, cdn);\n        });\n\n        // FIXME NO FUNCIONA CON TAB, SOLO HACIENDO CLICK Y ENTER.  Si se presiona TAB, SE BORRA!\n\t\t/*frm.fields_dict.items.grid.wrapper.on('blur', 'input[data-fieldname=\"item_code\"][data-doctype=\"Sales Invoice Item\"]', function(e) {\n\t\t\tconsole.log(\"Blurred away from the Item Code Field\");\n\t\t\teach_item(frm, cdt, cdn);\n\t\t\t//facelec_tax_calc_new(frm, cdt, cdn);\n\t\t});*/\n        frm.fields_dict.items.grid.wrapper.on('click', 'input[data-fieldname=\"uom\"][data-doctype=\"Quotation Item\"]', function (e) {\n            quotation_each_item(frm, cdt, cdn);\n        });\n\n        frm.fields_dict.items.grid.wrapper.on('blur focusout', 'input[data-fieldname=\"uom\"][data-doctype=\"Quotation Item\"]', function (e) {\n            quotation_each_item(frm, cdt, cdn);\n        });\n\n        // Do not refresh with each_item in Mouse leave! just recalculate\n        frm.fields_dict.items.grid.wrapper.on('mouseleave', 'input[data-fieldname=\"uom\"][data-doctype=\"Quotation Item\"]', function (e) {\n            shs_quotation_calculation(frm, cdt, cdn);\n        });\n\n        // This part might seem counterintuitive, but it is the \"next\" field in tab order after item code, which helps for a \"creative\" strategy to update everything after pressing TAB out of the item code field.  FIXME\n        frm.fields_dict.items.grid.wrapper.on('focus', 'input[data-fieldname=\"item_name\"][data-doctype=\"Quotation Item\"]', function (e) {\n            quotation_each_item(frm, cdt, cdn);\n            coti_insertar_fila_otro_impuesto(frm, cdt, cdn);\n        });\n\n        frm.fields_dict.items.grid.wrapper.on('blur focusout', 'input[data-fieldname=\"qty\"][data-doctype=\"Quotation Item\"]', function (e) {\n            quotation_each_item(frm, cdt, cdn);\n        });\n\n        // Do not refresh with each_item in Mouse leave! just recalculate\n        frm.fields_dict.items.grid.wrapper.on('mouseleave', 'input[data-fieldname=\"qty\"][data-doctype=\"Quotation Item\"]', function (e) {\n            quotation_each_item(frm, cdt, cdn);\n            shs_quotation_calculation(frm, cdt, cdn);\n        });\n\n        // DO NOT USE Keyup, ??  FIXME FIXME FIXME FIXME FIXME  este hace calculos bien\n        frm.fields_dict.items.grid.wrapper.on('blur focusout', 'input[data-fieldname=\"conversion_factor\"][data-doctype=\"Quotation Item\"]', function (e) {\n            //  IMPORTANT! IMPORTANT!  This is the one that gets the calculations correct!\n            // Trying to calc first, then refresh, or no refresh at all...\n            quotation_each_item(frm, cdt, cdn);\n            cur_frm.refresh_field(\"conversion_factor\");\n        });\n\n        // This specific one is only for keyup events, to recalculate all. Only on blur will it refresh everything!\n        // Do not refresh with each_item in Mouse leave OR keyup! just recalculate\n        frm.fields_dict.items.grid.wrapper.on('keyup mouseleave focusout', 'input[data-fieldname=\"conversion_factor\"][data-doctype=\"Quotation Item\"]', function (e) {\n            // Trying to calc first, then refresh, or no refresh at all...\n            shs_quotation_calculation(frm, cdt, cdn);\n            quotation_each_item(frm, cdt, cdn);\n            cur_frm.refresh_field(\"conversion_factor\");\n        });\n\n        // en-US: Enabling event listeners in the main doctype\n        // es-GT: Habilitando escuchadores de eventos en el tipo de documento principal\n        // When ANY key is released after being pressed\n        cur_frm.fields_dict.customer.$input.on(\"keyup\", function (evt) {\n            // shs_quotation_calculation(frm, cdt, cdn);\n            // quotation_each_item(frm, cdt, cdn);\n            // refresh_field('qty');\n        });\n\n        // When mouse leaves the field\n        cur_frm.fields_dict.customer.$input.on(\"mouseleave blur focusout\", function (evt) {\n            shs_quotation_calculation(frm, cdt, cdn);\n        });\n\n        // Mouse clicks over the items field\n        cur_frm.fields_dict.items.$wrapper.on(\"click\", function (evt) {\n            quotation_each_item(frm, cdt, cdn);\n        });\n\n        // Focusout from the field\n        cur_frm.fields_dict.taxes_and_charges.$input.on(\"focusout\", function (evt) {\n            shs_quotation_calculation(frm, cdt, cdn);\n            coti_insertar_fila_otro_impuesto(frm, cdt, cdn);\n        });\n    },\n    facelec_qt_nit: function (frm, cdt, cdn) {\n        // Funcion para validar NIT: Se ejecuta cuando exista un cambio en el campo de NIT\n        valNit(frm.doc.facelec_qt_nit, frm.doc.customer, frm);\n    },\n    discount_amount: function (frm, cdt, cdn) {\n        // Trigger Monto de descuento\n        var tax_before_calc = frm.doc.facelec_total_iva;;\n        // es-GT: Este muestra el IVA que se calculo por medio de nuestra aplicación.\n        var discount_amount_net_value = (frm.doc.discount_amount / (1 + (cur_frm.doc.taxes[0].rate / 100)));\n\n        if (discount_amount_net_value == NaN || discount_amount_net_value == undefined) {\n        } else {\n            // console.log(\"El descuento parece ser un numero definido, calculando con descuento.\");\n            discount_amount_tax_value = (discount_amount_net_value * (cur_frm.doc.taxes[0].rate / 100));\n            // console.log(\"El IVA del descuento es:\" + discount_amount_tax_value);\n            frm.doc.facelec_total_iva = (frm.doc.facelec_total_iva - discount_amount_tax_value);\n            // console.log(\"El IVA ya sin el iva del descuento es ahora:\" + frm.doc.facelec_total_iva);\n        }\n    },\n    before_save: function (frm, cdt, cdn) {\n        quotation_each_item(frm, cdt, cdn);\n        coti_insertar_fila_otro_impuesto(frm, cdt, cdn);\n        // Trigger antes de guardar\n    },\n});\n\nfrappe.ui.form.on(\"Quotation Item\", {\n    before_items_remove: function (frm, cdt, cdn) {\n        frm.doc.items.forEach((item_row_1, index_1) => {\n            if (item_row_1.name == cdn) {\n                coti_total_otros_impuestos_eliminacion(frm, item_row_1.facelec_qt_tax_rate_per_uom_account, item_row_1.facelec_qt_other_tax_amount);\n            }\n        });\n    },\n    items_remove: function (frm, cdt, cdn) {\n        // es-GT: Este disparador corre al momento de eliminar una nueva fila.\n        // en-US: This trigger runs when removing a row.\n        // Vuelve a calcular los totales de FUEL, GOODS, SERVICES e IVA cuando se elimina una fila.\n\n        var fix_gt_tax_fuel = 0;\n        var fix_gt_tax_goods = 0;\n        var fix_gt_tax_services = 0;\n        var fix_gt_tax_iva = 0;\n\n        $.each(frm.doc.items || [], function (i, d) {\n            fix_gt_tax_fuel += flt(d.facelec_qt_gt_tax_net_fuel_amt);\n            fix_gt_tax_goods += flt(d.facelec_qt_gt_tax_net_goods_amt);\n            fix_gt_tax_services += flt(d.facelec_qt_gt_tax_net_services_amt);\n            fix_gt_tax_iva += flt(d.facelec_qt_sales_tax_for_this_row);\n        });\n\n        cur_frm.set_value(\"facelec_qt_gt_tax_fuel\", fix_gt_tax_fuel);\n        cur_frm.set_value(\"facelec_qt_gt_tax_goods\", fix_gt_tax_goods);\n        cur_frm.set_value(\"facelec_qt_gt_tax_services\", fix_gt_tax_services);\n        cur_frm.set_value(\"facelec_qt_total_iva\", fix_gt_tax_iva);\n    },\n    item_code: function (frm, cdt, cdn) {\n        // Trigger codigo de producto\n        var this_company_sales_tax_var = cur_frm.doc.taxes[0].rate;\n        // console.log(\"If you can see this, tax rate variable now exists, and its set to: \" + this_company_sales_tax_var);\n        refresh_field('qty');\n    },\n    qty: function (frm, cdt, cdn) {\n        // Trigger cantidad\n        shs_quotation_calculation(frm, cdt, cdn);\n        // console.log(\"cdt contains: \" + cdt);\n        // console.log(\"cdn contains: \" + cdn);\n    },\n    uom: function (frm, cdt, cdn) {\n        // Trigger UOM\n        // console.log(\"The unit of measure field was changed and the code from the trigger was run\");\n    },\n    conversion_factor: function (frm, cdt, cdn) {\n        // Trigger factor de conversion\n        // console.log(\"El disparador de factor de conversión se corrió.\");\n        shs_quotation_calculation(frm, cdt, cdn);\n    },\n    rate: function (frm, cdt, cdn) {\n        shs_quotation_calculation(frm, cdt, cdn);\n    }\n});\n\n/* ----------------------------------------------------------------------------------------------------------------- */","import { valNit } from './facelec.js';\nimport { goalSeek } from './goalSeek.js';\n\n//console.log(\"Hello world from Purchase Invoice\");\n\n/* Purchase Invoice (Factura de Compra) ------------------------------------------------------------------------------------------------------- */\nfunction pi_each_item(frm, cdt, cdn) {\n    frm.doc.items.forEach((item) => {\n        shs_purchase_invoice_calculation(frm, \"Purchase Invoice Item\", item.name);\n        pi_insertar_fila_otro_impuesto(frm, \"Purchase Invoice Item\", item.name);\n    });\n}\n\n/**\n* Parametros:\n* #1 frm = formulario que se esta trabajando\n* #2 tax_account = nombre de la cuenta\n*\n* Funcionamiento:\n* Recorre la tabla items, por cada item que encuentre con el nombre de\n* cuenta recibido, lo ira concatenando en una variable que al finalizar\n* el recorrido de la tabla lo retornara a quien haya invocado la fucnion\n*/\nfunction pi_sumatoria_por_cuenta_items(frm, tax_account) {\n    var total_sumatoria = 0;\n\n    $.each(frm.doc.items || [], function (i, d) {\n        if (d.facelec_p_tax_rate_per_uom_account === tax_account) {\n            total_sumatoria += flt(d.facelec_p_other_tax_amount);\n        };\n    });\n\n    return total_sumatoria;\n}\n\n/**\n* Parametros:\n* #1 frm = formulario que se esta trabajando\n* #2 cdt = Doctype\n* #3 cdn = Docname\n*\n* Funcionamiento:\n* Recorre la tabla items, por cada item encontrado, si tiene una cuenta asignada,\n* recorrera la tabla hija shs_pi_otros_impuestos en busca de items con el mismo nombre\n* de cuenta anteriormente encontrado, para totalizar el valor del impuestos, para todos\n* los items con la misma cuenta.\n*/\nfunction pi_sumatoria_otros_impuestos_por_cuenta(frm, cdt, cdn) {\n    frm.doc.items.forEach((item_row_1, index_1) => {\n        if (item_row_1.name === cdn) {\n            if (item_row_1.facelec_p_tax_rate_per_uom_account) {\n\n                frm.doc.shs_pi_otros_impuestos.forEach((tax_row_2, index_2) => {\n\n                    if (tax_row_2.account_head === item_row_1.facelec_p_tax_rate_per_uom_account) {\n                        var totalizador = 0;\n                        totalizador = pi_sumatoria_por_cuenta_items(frm, tax_row_2.account_head)\n                        cur_frm.doc.shs_pi_otros_impuestos[index_2].total = totalizador;\n                        pi_total_de_otros_impuestos(frm);\n                    }\n\n                });\n\n            }\n        }\n    });\n}\n\n/**\n* Parametros:\n* #1 frm = formulario que se esta trabajando\n*\n* Funcionamiento:\n* Recorre la tabla hija shs_pi_otros_impuestos, realiza sumatoria de todos las filas\n* que tenga una cuenta, el valor totalizado se asigna al campo shs_total_otros_imp_incl\n*/\nfunction pi_total_de_otros_impuestos(frm) {\n    var total_tax = 0;\n\n    $.each(frm.doc.shs_pi_otros_impuestos || [], function (i, d) {\n        if (d.account_head) {\n            total_tax += flt(d.total);\n        };\n    });\n\n    cur_frm.set_value('shs_pi_total_otros_imp_incl', total_tax);\n    frm.refresh_field(\"shs_pi_total_otros_imp_incl\");\n}\n\n/**\n* Parametros:\n* #1 frm = formulario que se esta trabajando\n* #2 cdt = Doctype\n* #3 cdn = Docname\n*\n* Funcionamiento:\n* Recorre la tabla items, por cada fila con una cuenta asignada buscara en la tabla hija\n* shs_pi_otros_impuestos por una fila con el mismo nombre de la cuenta anteriormente encontrada,\n* si no la encuentra en shs_pi_otros_impuestos creara una nueva fila, y le asignara los valores\n* de nombre de cuenta y el total para esa cuenta. Si la cuenta ya se encuentra creada en\n* shs_pi_otros_impuestos le sumara los valores encontrados.\n*/\nfunction pi_insertar_fila_otro_impuesto(frm, cdt, cdn) {\n    var shs_otro_impuesto = 0;\n\n    frm.doc.items.forEach((item_row_i, indice) => {\n        if (item_row_i.name === cdn) {\n            shs_otro_impuesto = item_row_i.facelec_p_other_tax_amount;\n\n            // Guarda el nombre de la cuenta del item seleccionado\n            var cuenta = item_row_i.facelec_p_tax_rate_per_uom_account;\n            // console.log('Cuenta de item encontrada es : ' + cuenta);\n\n            frm.refresh_field('items');\n            frm.refresh_field('conversion_factor');\n\n            if (cuenta) { // Si encuentra una cuenta con nombre procede\n                if (!(pi_buscar_cuenta(frm, cuenta))) { // Si no encuentra una cuenta, procede.\n\n                    frappe.model.add_child(cur_frm.doc, \"Otros Impuestos Factura Electronica\", \"shs_pi_otros_impuestos\");\n                    // Refresh datos de la tabla hija items\n                    cur_frm.refresh_field('items');\n                    // Recorre la tabla hija 'taxes' en busca de la nueva fila que se agrego anteriormente donde account_head\n                    // sea undefined\n                    frm.doc.shs_pi_otros_impuestos.forEach((tax_row, index) => {\n\n                        // Si encuentra la fila anteriormente agregada procede\n                        if (tax_row.account_head === undefined) {\n                            // Asigna valores en la fila recien creada\n                            cur_frm.doc.shs_pi_otros_impuestos[index].account_head = cuenta;\n                            cur_frm.doc.shs_pi_otros_impuestos[index].total = shs_otro_impuesto;\n                            // Actualiza los datos de la tabla hija\n                            cur_frm.refresh_field(\"shs_pi_otros_impuestos\");\n                            // Funcion que se encarda de sumar los valores por cuenta\n                            pi_sumatoria_otros_impuestos_por_cuenta(frm, cdt, cdn);\n                            cur_frm.refresh_field(\"shs_pi_otros_impuestos\");\n                        }\n\n                    });\n\n                } else { // Si la cuenta ya esta agregada en shs_pi_otros_impuestos, se procede a sumar sobre los valores\n                    // ya existentes\n                    // Funcion que se encarda de sumar los valores por cuenta\n                    pi_sumatoria_otros_impuestos_por_cuenta(frm, cdt, cdn);\n                    cur_frm.refresh_field(\"shs_pi_otros_impuestos\");\n                }\n            }\n        }\n    });\n\n}\n\n/**\n* Se encarga de recalcular el total de otros impuestos cuando se elimina un item\n*/\nfunction pi_total_otros_impuestos_eliminacion(frm, tax_account_n, otro_impuesto) {\n    // Recorre items\n    frm.doc.items.forEach((item_row, i1) => {\n        if (item_row.facelec_p_tax_rate_per_uom_account === tax_account_n) {\n            var total = (pi_sumatoria_por_cuenta_items(frm, tax_account_n) - otro_impuesto);\n            // recorre shs_pi_otros_impuestos\n\n            if (frm.doc.shs_pi_otros_impuestos !== undefined) {\n                frm.doc.shs_pi_otros_impuestos.forEach((tax_row, i2) => {\n                    if (tax_row.account_head === tax_account_n) {\n                        cur_frm.doc.shs_pi_otros_impuestos[i2].total = total;\n                        cur_frm.refresh_field(\"shs_pi_otros_impuestos\");\n                        pi_total_de_otros_impuestos(frm);\n                        cur_frm.refresh_field(\"shs_pi_otros_impuestos\");\n\n                        if (!tax_row.total) {\n                            // Elimina la fila con valor 0\n                            cur_frm.doc.shs_pi_otros_impuestos.splice(cur_frm.doc.shs_pi_otros_impuestos[i2], 1);\n                            cur_frm.refresh_field(\"shs_pi_otros_impuestos\");\n                        }\n                    }\n                });\n            }\n\n        }\n    });\n\n}\n\n/**\n* Funcionamiento: recibe como parametro frm, y cuenta_b, lo que hace es, buscar en todas las filas de taxes\n* si existe ya una cuenta con el nombre de la cuenta recibida por parametro, en caso ya exista esa cuenta en\n* la tabla no hace nada, pero si encuentra que no hay una cuenta igual a la recibida en el parametro, entonces\n* la funcion encargada agregara una nueva fila con los datos correspondientes, esta funcion retorna true\n* en caso si encuentre una cuenta existente\n*/\nfunction pi_buscar_cuenta(frm, cuenta_b) {\n\n    var estado = false;\n\n    $.each(frm.doc.shs_pi_otros_impuestos || [], function (i, d) {\n        if (d.account_head === cuenta_b) {\n            estado = true;\n        }\n    });\n\n    return estado;\n}\n\n// Calculos para Factura de Compra\nfunction shs_purchase_invoice_calculation(frm, cdt, cdn) {\n    cur_frm.refresh_fields();\n    var this_company_sales_tax_var = cur_frm.doc.taxes[0].rate;\n\n    var this_row_amount = 0;\n    var this_row_stock_qty = 0;\n    var this_row_tax_rate = 0;\n    var this_row_tax_amount = 0;\n    var this_row_taxable_amount = 0;\n\n    frm.doc.items.forEach((item_row, index) => {\n\n        if (item_row.name == cdn) {\n            this_row_amount = (item_row.qty * item_row.rate);\n            this_row_stock_qty = (item_row.qty * item_row.conversion_factor);\n            this_row_tax_rate = (item_row.facelec_p_tax_rate_per_uom);\n            this_row_tax_amount = (this_row_stock_qty * this_row_tax_rate);\n            this_row_taxable_amount = (this_row_amount - this_row_tax_amount);\n\n            frm.doc.items[index].facelec_p_other_tax_amount = ((item_row.facelec_p_tax_rate_per_uom * (item_row.qty * item_row.conversion_factor)));\n            //OJO!  No s epuede utilizar stock_qty en los calculos, debe de ser qty a puro tubo!\n            frm.doc.items[index].facelec_p_amount_minus_excise_tax = ((item_row.qty * item_row.rate) - ((item_row.qty * item_row.conversion_factor) * item_row.facelec_p_tax_rate_per_uom));\n\n            if (item_row.facelec_p_is_fuel) {\n                frm.doc.items[index].facelec_p_gt_tax_net_fuel_amt = (item_row.facelec_p_amount_minus_excise_tax / (1 + (this_company_sales_tax_var / 100)));\n                frm.doc.items[index].facelec_p_sales_tax_for_this_row = (item_row.facelec_p_gt_tax_net_fuel_amt * (this_company_sales_tax_var / 100));\n                // Sumatoria de todos los que tengan el check combustibles\n                let total_fuel = 0;\n                $.each(frm.doc.items || [], function (i, d) {\n                    if (d.facelec_p_is_fuel == true) {\n                        total_fuel += flt(d.facelec_p_gt_tax_net_fuel_amt);\n                    };\n                });\n                frm.doc.facelec_p_gt_tax_fuel = total_fuel;\n            };\n\n            if (item_row.facelec_p_is_good) {\n                frm.doc.items[index].facelec_p_gt_tax_net_goods_amt = (item_row.facelec_p_amount_minus_excise_tax / (1 + (this_company_sales_tax_var / 100)));\n                frm.doc.items[index].facelec_p_sales_tax_for_this_row = (item_row.facelec_p_gt_tax_net_goods_amt * (this_company_sales_tax_var / 100));\n                // Sumatoria de todos los que tengan el check bienes\n                let total_goods = 0;\n                $.each(frm.doc.items || [], function (i, d) {\n                    if (d.facelec_p_is_good == true) {\n                        total_goods += flt(d.facelec_p_gt_tax_net_goods_amt);\n                    };\n                });\n                frm.doc.facelec_p_gt_tax_goods = total_goods;\n            };\n\n            if (item_row.facelec_p_is_service == 1) {\n                frm.doc.items[index].facelec_p_gt_tax_net_services_amt = (item_row.facelec_p_amount_minus_excise_tax / (1 + (this_company_sales_tax_var / 100)));\n                frm.doc.items[index].facelec_p_sales_tax_for_this_row = (item_row.facelec_p_gt_tax_net_services_amt * (this_company_sales_tax_var / 100));\n                // Sumatoria de todos los que tengan el check servicios\n                let total_servi = 0;\n                $.each(frm.doc.items || [], function (i, d) {\n                    if (d.facelec_p_is_service == true) {\n                        total_servi += flt(d.facelec_p_gt_tax_net_services_amt);\n                    };\n                });\n                frm.doc.facelec_p_gt_tax_services = total_servi;\n            };\n\n            let full_tax_iva = 0;\n            $.each(frm.doc.items || [], function (i, d) {\n                full_tax_iva += flt(d.facelec_p_sales_tax_for_this_row);\n            });\n            frm.doc.facelec_p_total_iva = full_tax_iva;\n        };\n    });\n}\n\n// Funcion para generar tabla HTML + Jinja\nfunction generar_tabla_html_factura_compra(frm) {\n    // PURCHASE INVOICE\n    if (frm.doc.items.length > 0) {\n        const mi_array = frm.doc.items;\n        const mi_array_dos = Array.from(mi_array);\n        // console.log(mi_array_dos);\n        frappe.call({\n            method: \"factura_electronica.api.generar_tabla_html_factura_compra\",\n            args: {\n                tabla: JSON.stringify(mi_array_dos)\n            },\n            callback: function (data) {\n                frm.set_value('other_tax_facelec', data.message);\n                frm.refresh_field(\"other_tax_facelec\");\n            }\n        });\n    }\n}\n\nfrappe.ui.form.on(\"Purchase Invoice\", {\n    onload_post_render: function (frm, cdt, cdn) {\n        // Funciona unicamente cuando se carga por primera vez el documento y aplica unicamente para el form y no childtables\n\n        // en-US: Enabling event listeners for child tables\n        // es-GT: Habilitando escuchadores de eventos en las tablas hijas del tipo de documento principal\n        // No corra KEY UP, KEY PRESS, KEY DOWN en este campo!   NO NO NO NO NONONO\n        frm.fields_dict.items.grid.wrapper.on('click focusout blur', 'input[data-fieldname=\"item_code\"][data-doctype=\"Purchase Invoice Item\"]', function (e) {\n            shs_purchase_invoice_calculation(frm, cdt, cdn);\n            pi_each_item(frm, cdt, cdn);\n        });\n\n        // frm.fields_dict.items.grid.wrapper.on('click focusout blur', 'input[data-fieldname=\"shs_amount_for_back_calc\"][data-doctype=\"Purchase Invoice Item\"]', function (e) {\n        //     shs_purchase_invoice_calculation(frm, cdt, cdn);\n        //     pi_each_item(frm, cdt, cdn);\n        // });\n\n        // FIXME NO FUNCIONA CON TAB, SOLO HACIENDO CLICK Y ENTER.  Si se presiona TAB, SE BORRA!\n\t\t/*frm.fields_dict.items.grid.wrapper.on('blur', 'input[data-fieldname=\"item_code\"][data-doctype=\"Sales Invoice Item\"]', function(e) {\n\t\t\tconsole.log(\"Blurred away from the Item Code Field\");\n\t\t\teach_item(frm, cdt, cdn);\n\t\t\t//facelec_tax_calc_new(frm, cdt, cdn);\n\t\t});*/\n        frm.fields_dict.items.grid.wrapper.on('click', 'input[data-fieldname=\"uom\"][data-doctype=\"Purchase Invoice Item\"]', function (e) {\n            pi_each_item(frm, cdt, cdn);\n        });\n\n        frm.fields_dict.items.grid.wrapper.on('blur focusout', 'input[data-fieldname=\"uom\"][data-doctype=\"Purchase Invoice Item\"]', function (e) {\n            pi_each_item(frm, cdt, cdn);\n        });\n\n        // Do not refresh with each_item in Mouse leave! just recalculate\n        frm.fields_dict.items.grid.wrapper.on('mouseleave', 'input[data-fieldname=\"uom\"][data-doctype=\"Purchase Invoice Item\"]', function (e) {\n            shs_purchase_invoice_calculation(frm, cdt, cdn);\n        });\n\n        // This part might seem counterintuitive, but it is the \"next\" field in tab order after item code, which helps for a \"creative\" strategy to update everything after pressing TAB out of the item code field.  FIXME\n        frm.fields_dict.items.grid.wrapper.on('focus', 'input[data-fieldname=\"item_name\"][data-doctype=\"Purchase Invoice Item\"]', function (e) {\n            pi_each_item(frm, cdt, cdn);\n            pi_insertar_fila_otro_impuesto(frm, cdt, cdn);\n        });\n\n        frm.fields_dict.items.grid.wrapper.on('blur focusout', 'input[data-fieldname=\"qty\"][data-doctype=\"Purchase Invoice Item\"]', function (e) {\n            pi_each_item(frm, cdt, cdn);\n        });\n\n        // Do not refresh with each_item in Mouse leave! just recalculate\n        frm.fields_dict.items.grid.wrapper.on('mouseleave', 'input[data-fieldname=\"qty\"][data-doctype=\"Purchase Invoice Item\"]', function (e) {\n            pi_each_item(frm, cdt, cdn);\n            shs_purchase_invoice_calculation(frm, cdt, cdn);\n        });\n\n        // DO NOT USE Keyup, ??  FIXME FIXME FIXME FIXME FIXME  este hace calculos bien\n        frm.fields_dict.items.grid.wrapper.on('blur focusout', 'input[data-fieldname=\"conversion_factor\"][data-doctype=\"Purchase Invoice Item\"]', function (e) {\n            //  IMPORTANT! IMPORTANT!  This is the one that gets the calculations correct!\n            // Trying to calc first, then refresh, or no refresh at all...\n            pi_each_item(frm, cdt, cdn);\n            cur_frm.refresh_field(\"conversion_factor\");\n        });\n\n        // This specific one is only for keyup events, to recalculate all. Only on blur will it refresh everything!\n        // Do not refresh with each_item in Mouse leave OR keyup! just recalculate\n        frm.fields_dict.items.grid.wrapper.on('keyup mouseleave focusout', 'input[data-fieldname=\"conversion_factor\"][data-doctype=\"Purchase Invoice Item\"]', function (e) {\n            // Trying to calc first, then refresh, or no refresh at all...\n            shs_purchase_invoice_calculation(frm, cdt, cdn);\n            pi_each_item(frm, cdt, cdn);\n            cur_frm.refresh_field(\"conversion_factor\");\n        });\n\n        // en-US: Enabling event listeners in the main doctype\n        // es-GT: Habilitando escuchadores de eventos en el tipo de documento principal\n        // When ANY key is released after being pressed\n        cur_frm.fields_dict.supplier.$input.on(\"keyup\", function (evt) {\n            // shs_purchase_invoice_calculation(frm, cdt, cdn);\n            // pi_each_item(frm, cdt, cdn);\n            // refresh_field('qty');\n        });\n\n        // When mouse leaves the field\n        cur_frm.fields_dict.supplier.$input.on(\"mouseleave blur focusout\", function (evt) {\n            shs_purchase_invoice_calculation(frm, cdt, cdn);\n        });\n\n        // Mouse clicks over the items field\n        cur_frm.fields_dict.items.$wrapper.on(\"click\", function (evt) {\n            pi_each_item(frm, cdt, cdn);\n        });\n\n        // Focusout from the field\n        cur_frm.fields_dict.taxes_and_charges.$input.on(\"focusout\", function (evt) {\n            shs_purchase_invoice_calculation(frm, cdt, cdn);\n            pi_insertar_fila_otro_impuesto(frm, cdt, cdn);\n        });\n    },\n    facelec_nit_fproveedor: function (frm, cdt, cdn) {\n        // Funcion para validar NIT: Se ejecuta cuando exista un cambio en el campo de NIT\n        valNit(frm.doc.facelec_nit_fproveedor, frm.doc.supplier, frm);\n    },\n    discount_amount: function (frm, cdt, cdn) {\n        // Trigger Monto de descuento\n        var tax_before_calc = frm.doc.facelec_total_iva;;\n        // es-GT: Este muestra el IVA que se calculo por medio de nuestra aplicación.\n        var discount_amount_net_value = (frm.doc.discount_amount / (1 + (cur_frm.doc.taxes[0].rate / 100)));\n\n        if (discount_amount_net_value == NaN || discount_amount_net_value == undefined) {\n        } else {\n            // console.log(\"El descuento parece ser un numero definido, calculando con descuento.\");\n            discount_amount_tax_value = (discount_amount_net_value * (cur_frm.doc.taxes[0].rate / 100));\n            // console.log(\"El IVA del descuento es:\" + discount_amount_tax_value);\n            frm.doc.facelec_total_iva = (frm.doc.facelec_total_iva - discount_amount_tax_value);\n            // console.log(\"El IVA ya sin el iva del descuento es ahora:\" + frm.doc.facelec_total_iva);\n        }\n    },\n    before_save: function (frm, cdt, cdn) {\n        pi_each_item(frm, cdt, cdn);\n        pi_insertar_fila_otro_impuesto(frm, cdt, cdn);\n        // Trigger antes de guardar\n    },\n    validate: function (frm) {\n        generar_tabla_html_factura_compra(frm);\n    },\n    on_submit: function (frm, cdt, cdn) {\n        // Ocurre cuando se presione el boton validar.\n        // Cuando se valida el documento, se hace la consulta al servidor por medio de frappe.call\n\n        // Creacion objeto vacio para guardar nombre y valor de las cuentas que se encuentren\n        let cuentas_registradas = {};\n\n        // Recorre la tabla hija en busca de cuentas\n        frm.doc.shs_pi_otros_impuestos.forEach((tax_row, index) => {\n            if (tax_row.account_head) {\n                // Agrega un nuevo valor al objeto (JSON-DICCIONARIO) con el\n                // nombre, valor de la cuenta\n                cuentas_registradas[tax_row.account_head] = tax_row.total;\n            };\n        });\n        // console.log(cuentas_registradas);\n        // console.log(Object.keys(cuentas_registradas).length);\n\n        // Si existe por lo menos una cuenta, se ejecuta frappe.call\n        if (Object.keys(cuentas_registradas).length > 0) {\n            frappe.call({\n                method: \"factura_electronica.special_tax.add_gl_entry_other_special_tax\",\n                args: {\n                    invoice_name: frm.doc.name,\n                    accounts: cuentas_registradas,\n                    invoice_type: \"Purchase Invoice\"\n                },\n                // El callback se ejecuta tras finalizar la ejecucion del script python del lado\n                // del servidor\n                callback: function () {\n                    // frm.reload_doc();\n                }\n            });\n        }\n    },\n    naming_series: function (frm, cdt, cdn) {\n        // frappe call\n        // verifica si la serie es de factura especial\n        // si es verdadero\n        //obtiene la tabla de purchase taxes and charges\n        // borra la existente\n        // carga la nueva\n        // actualiza un campo read only de tipo chequecito que diga: \"Factura Especial\"\n        console.log(frm.doc.naming_series);\n\n        frappe.call({\n            method: \"factura_electronica.special_invoice.verificar_existencia_series\",\n            args: {\n                serie: frm.doc.naming_series\n            },\n            callback: function (r) {\n                // frm.reload_doc();\n                console.log(r.message);\n\n                if (r.message != 'fail') {\n                    // Limpia la tabla hija de Purchase Taxes and Charges\n                    cur_frm.clear_table(\"taxes\");\n                    cur_frm.refresh_fields();\n\n                    // Asigna el nombre de la plantilla de impuestos a utilizar configurada\n                    frm.set_value('taxes_and_charges', r.message[2]);\n                    frm.refresh_field(\"taxes_and_charges\");\n                }\n            }\n        });\n    }\n});\n\nfrappe.ui.form.on(\"Purchase Invoice Item\", {\n    before_items_remove: function (frm, cdt, cdn) {\n        frm.doc.items.forEach((item_row_1, index_1) => {\n            if (item_row_1.name == cdn) {\n                pi_total_otros_impuestos_eliminacion(frm, item_row_1.facelec_p_tax_rate_per_uom_account, item_row_1.facelec_p_other_tax_amount);\n            }\n        });\n    },\n    items_remove: function (frm, cdt, cdn) {\n        // es-GT: Este disparador corre al momento de eliminar una nueva fila.\n        // en-US: This trigger runs when removing a row.\n        // Vuelve a calcular los totales de FUEL, GOODS, SERVICES e IVA cuando se elimina una fila.\n\n        var fix_gt_tax_fuel = 0;\n        var fix_gt_tax_goods = 0;\n        var fix_gt_tax_services = 0;\n        var fix_gt_tax_iva = 0;\n\n        $.each(frm.doc.items || [], function (i, d) {\n            fix_gt_tax_fuel += flt(d.facelec_p_gt_tax_net_fuel_amt);\n            fix_gt_tax_goods += flt(d.facelec_p_gt_tax_net_goods_amt);\n            fix_gt_tax_services += flt(d.facelec_p_gt_tax_net_services_amt);\n            fix_gt_tax_iva += flt(d.facelec_p_sales_tax_for_this_row);\n        });\n\n        cur_frm.set_value(\"facelec_p_gt_tax_fuel\", fix_gt_tax_fuel);\n        cur_frm.set_value(\"facelec_p_gt_tax_goods\", fix_gt_tax_goods);\n        cur_frm.set_value(\"facelec_p_gt_tax_services\", fix_gt_tax_services);\n        cur_frm.set_value(\"facelec_p_total_iva\", fix_gt_tax_iva);\n    },\n    item_code: function (frm, cdt, cdn) {\n        // Trigger codigo de producto\n        var this_company_sales_tax_var = cur_frm.doc.taxes[0].rate;\n        // console.log(\"If you can see this, tax rate variable now exists, and its set to: \" + this_company_sales_tax_var);\n        refresh_field('qty');\n    },\n    qty: function (frm, cdt, cdn) {\n        // Trigger cantidad\n        shs_purchase_invoice_calculation(frm, cdt, cdn);\n        // console.log(\"cdt contains: \" + cdt);\n        // console.log(\"cdn contains: \" + cdn);\n    },\n    uom: function (frm, cdt, cdn) {\n        // Trigger UOM\n        // console.log(\"The unit of measure field was changed and the code from the trigger was run\");\n    },\n    conversion_factor: function (frm, cdt, cdn) {\n        // Trigger factor de conversion\n        // console.log(\"El disparador de factor de conversión se corrió.\");\n        shs_purchase_invoice_calculation(frm, cdt, cdn);\n    },\n    rate: function (frm, cdt, cdn) {\n        shs_purchase_invoice_calculation(frm, cdt, cdn);\n    },\n    shs_amount_for_back_calc: function (frm, cdt, cdn) {\n        frm.doc.items.forEach((row, index) => {\n            // console.log(row.rate);\n            // console.log(row.qty);\n            // console.log(row.amount);\n            var a = row.rate;\n            var b = row.qty;\n            var c = row.amount;\n\n            //let test = flt(row.shs_amount_for_back_calc) - flt(c);\n            //let testB = test / 2;\n\n            // Usando metodologia GoalSeek.js\n            // https://github.com/adam-hanna/goalSeek.js/blob/master/goalSeek.js\n            // console.log(goalSeek({\n            //     Func: calculo_prueba,\n            //     aFuncParams: [b, a],\n            //     oFuncArgTarget: {\n            //         Position: 0\n            //     },\n            //     Goal: row.shs_amount_for_back_calc,\n            //     Tol: 0.001,\n            //     maxIter: 10000\n            // }));\n            let calcu = goalSeek({\n                Func: redondeo_sales_invoice,\n                aFuncParams: [b, a],\n                oFuncArgTarget: {\n                    Position: 0\n                },\n                Goal: row.shs_amount_for_back_calc,\n                Tol: 0.001,\n                maxIter: 10000\n            });\n            console.log(calcu);\n\n            frm.doc.items[index].qty = calcu;\n            frm.doc.items[index].stock_qty = calcu;\n            frm.doc.items[index].amount = calcu * frm.doc.items[index].rate;\n            // frm.doc.items[index].qty = calcu;\n\n            // frm.set_value('qty', calcu);\n            frm.refresh_field(\"items\");\n\n            pi_each_item(frm, cdt, cdn);\n            pi_insertar_fila_otro_impuesto(frm, cdt, cdn);\n        });\n    }\n});\n\n\nfunction redondeo_sales_invoice(a, b) {\n    return a * b;\n}\n/* ----------------------------------------------------------------------------------------------------------------- */","import { valNit } from './facelec.js';\nimport { goalSeek } from './goalSeek.js';\n\n// console.log(\"Hello world from Purchase Receipt\");\n\n/* Purchase Receipt (Recibo de Compra ------------------------------------------------------------------------------------------------------- */\nfunction purchase_receipt_each_item(frm, cdt, cdn) {\n    frm.doc.items.forEach((item) => {\n        shs_purchase_receipt_calculation(frm, \"Purchase Receipt Item\", item.name);\n    });\n}\n\n// Calculos para Recibo de Compra\nfunction shs_purchase_receipt_calculation(frm, cdt, cdn) {\n    cur_frm.refresh_fields();\n    var this_company_sales_tax_var = cur_frm.doc.taxes[0].rate;\n\n    var this_row_amount = 0;\n    var this_row_stock_qty = 0;\n    var this_row_tax_rate = 0;\n    var this_row_tax_amount = 0;\n    var this_row_taxable_amount = 0;\n\n    frm.doc.items.forEach((item_row, index) => {\n\n        if (item_row.name == cdn) {\n            this_row_amount = (item_row.qty * item_row.rate);\n            this_row_stock_qty = (item_row.qty * item_row.conversion_factor);\n            this_row_tax_rate = (item_row.facelec_pr_tax_rate_per_uom);\n            this_row_tax_amount = (this_row_stock_qty * this_row_tax_rate);\n            this_row_taxable_amount = (this_row_amount - this_row_tax_amount);\n\n            frm.doc.items[index].facelec_pr_other_tax_amount = ((item_row.facelec_pr_tax_rate_per_uom * (item_row.qty * item_row.conversion_factor)));\n            //OJO!  No s epuede utilizar stock_qty en los calculos, debe de ser qty a puro tubo!\n            frm.doc.items[index].facelec_pr_amount_minus_excise_tax = ((item_row.qty * item_row.rate) - ((item_row.qty * item_row.conversion_factor) * item_row.facelec_pr_tax_rate_per_uom));\n\n            if (item_row.facelec_pr_is_fuel) {\n                frm.doc.items[index].facelec_pr_gt_tax_net_fuel_amt = (item_row.facelec_pr_amount_minus_excise_tax / (1 + (this_company_sales_tax_var / 100)));\n                frm.doc.items[index].facelec_pr_sales_tax_for_this_row = (item_row.facelec_pr_gt_tax_net_fuel_amt * (this_company_sales_tax_var / 100));\n                // Sumatoria de todos los que tengan el check combustibles\n                let total_fuel = 0;\n                $.each(frm.doc.items || [], function (i, d) {\n                    if (d.facelec_pr_is_fuel == true) {\n                        total_fuel += flt(d.facelec_pr_gt_tax_net_fuel_amt);\n                    };\n                });\n                frm.doc.facelec_pr_gt_tax_fuel = total_fuel;\n            };\n\n            if (item_row.facelec_pr_is_good) {\n                frm.doc.items[index].facelec_pr_gt_tax_net_goods_amt = (item_row.facelec_pr_amount_minus_excise_tax / (1 + (this_company_sales_tax_var / 100)));\n                frm.doc.items[index].facelec_pr_sales_tax_for_this_row = (item_row.facelec_pr_gt_tax_net_goods_amt * (this_company_sales_tax_var / 100));\n                // Sumatoria de todos los que tengan el check bienes\n                let total_goods = 0;\n                $.each(frm.doc.items || [], function (i, d) {\n                    if (d.facelec_pr_is_good == true) {\n                        total_goods += flt(d.facelec_pr_gt_tax_net_goods_amt);\n                    };\n                });\n                frm.doc.facelec_pr_gt_tax_goods = total_goods;\n            };\n\n            if (item_row.facelec_pr_is_service) {\n                frm.doc.items[index].facelec_pr_gt_tax_net_services_amt = (item_row.facelec_pr_amount_minus_excise_tax / (1 + (this_company_sales_tax_var / 100)));\n                frm.doc.items[index].facelec_pr_sales_tax_for_this_row = (item_row.facelec_pr_gt_tax_net_services_amt * (this_company_sales_tax_var / 100));\n                // Sumatoria de todos los que tengan el check servicios\n                let total_servi = 0;\n                $.each(frm.doc.items || [], function (i, d) {\n                    if (d.facelec_pr_is_service == true) {\n                        total_servi += flt(d.facelec_pr_gt_tax_net_services_amt);\n                    };\n                });\n                frm.doc.facelec_pr_gt_tax_services = total_servi;\n            };\n\n            let full_tax_iva = 0;\n            $.each(frm.doc.items || [], function (i, d) {\n                full_tax_iva += flt(d.facelec_pr_sales_tax_for_this_row);\n            });\n            frm.doc.facelec_pr_total_iva = full_tax_iva;\n        };\n    });\n}\n\nfrappe.ui.form.on(\"Purchase Receipt\", {\n    onload_post_render: function (frm, cdt, cdn) {\n        // en-US: Enabling event listeners for child tables\n        // es-GT: Habilitando escuchadores de eventos en las tablas hijas del tipo de documento principal\n        frm.fields_dict.items.grid.wrapper.on('click focusout blur', 'input[data-fieldname=\"item_code\"][data-doctype=\"Purchase Receipt Item\"]', function (e) {\n            shs_purchase_receipt_calculation(frm, cdt, cdn);\n            purchase_receipt_each_item(frm, cdt, cdn);\n        });\n\n        frm.fields_dict.items.grid.wrapper.on('click', 'input[data-fieldname=\"uom\"][data-doctype=\"Purchase Receipt Item\"]', function (e) {\n            purchase_receipt_each_item(frm, cdt, cdn);\n        });\n\n        frm.fields_dict.items.grid.wrapper.on('blur focusout', 'input[data-fieldname=\"uom\"][data-doctype=\"Purchase Receipt Item\"]', function (e) {\n            purchase_receipt_each_item(frm, cdt, cdn);\n        });\n\n        // Do not refresh with each_item in Mouse leave! just recalculate\n        frm.fields_dict.items.grid.wrapper.on('mouseleave', 'input[data-fieldname=\"uom\"][data-doctype=\"Purchase Receipt Item\"]', function (e) {\n            shs_purchase_receipt_calculation(frm, cdt, cdn);\n        });\n\n        // This part might seem counterintuitive, but it is the \"next\" field in tab order after item code, which helps for a \"creative\" strategy to update everything after pressing TAB out of the item code field.  FIXME\n        frm.fields_dict.items.grid.wrapper.on('focus', 'input[data-fieldname=\"item_name\"][data-doctype=\"Purchase Receipt Item\"]', function (e) {\n            purchase_receipt_each_item(frm, cdt, cdn);\n        });\n\n        frm.fields_dict.items.grid.wrapper.on('blur focusout', 'input[data-fieldname=\"qty\"][data-doctype=\"Purchase Receipt Item\"]', function (e) {\n            purchase_receipt_each_item(frm, cdt, cdn);\n        });\n\n        // Do not refresh with each_item in Mouse leave! just recalculate\n        frm.fields_dict.items.grid.wrapper.on('mouseleave', 'input[data-fieldname=\"qty\"][data-doctype=\"Purchase Receipt Item\"]', function (e) {\n            purchase_receipt_each_item(frm, cdt, cdn);\n            shs_purchase_receipt_calculation(frm, cdt, cdn);\n        });\n\n        // DO NOT USE Keyup, ??  FIXME FIXME FIXME FIXME FIXME  este hace calculos bien\n        frm.fields_dict.items.grid.wrapper.on('blur focusout', 'input[data-fieldname=\"conversion_factor\"][data-doctype=\"Purchase Receipt Item\"]', function (e) {\n            //  IMPORTANT! IMPORTANT!  This is the one that gets the calculations correct!\n            // Trying to calc first, then refresh, or no refresh at all...\n            purchase_receipt_each_item(frm, cdt, cdn);\n            cur_frm.refresh_field(\"conversion_factor\");\n        });\n\n        // This specific one is only for keyup events, to recalculate all. Only on blur will it refresh everything!\n        // Do not refresh with each_item in Mouse leave OR keyup! just recalculate\n        frm.fields_dict.items.grid.wrapper.on('keyup mouseleave focusout', 'input[data-fieldname=\"conversion_factor\"][data-doctype=\"Purchase Receipt Item\"]', function (e) {\n            // Trying to calc first, then refresh, or no refresh at all...\n            shs_purchase_receipt_calculation(frm, cdt, cdn);\n            purchase_receipt_each_item(frm, cdt, cdn);\n            cur_frm.refresh_field(\"conversion_factor\");\n        });\n\n        // en-US: Enabling event listeners in the main doctype\n        // es-GT: Habilitando escuchadores de eventos en el tipo de documento principal\n        // When ANY key is released after being pressed\n        cur_frm.fields_dict.supplier.$input.on(\"keyup\", function (evt) {\n            // shs_purchase_receipt_calculation(frm, cdt, cdn);\n            // purchase_receipt_each_item(frm, cdt, cdn);\n            // refresh_field('qty');\n        });\n\n        // When mouse leaves the field\n        cur_frm.fields_dict.supplier.$input.on(\"mouseleave blur focusout\", function (evt) {\n            shs_purchase_receipt_calculation(frm, cdt, cdn);\n        });\n\n        // Mouse clicks over the items field\n        cur_frm.fields_dict.items.$wrapper.on(\"click\", function (evt) {\n            purchase_receipt_each_item(frm, cdt, cdn);\n        });\n\n        // Focusout from the field\n        cur_frm.fields_dict.taxes_and_charges.$input.on(\"focusout\", function (evt) {\n            shs_purchase_receipt_calculation(frm, cdt, cdn);\n        });\n    },\n    facelec_nit_prproveedor: function (frm) {\n        // Funcion para validar NIT: Se ejecuta cuando exista un cambio en el campo de NIT\n        valNit(frm.doc.facelec_nit_prproveedor, frm.doc.supplier, frm);\n    },\n    discount_amount: function (frm) {\n        // Trigger Monto de descuento\n        var tax_before_calc = frm.doc.facelec_pr_total_iva;\n        // es-GT: Este muestra el IVA que se calculo por medio de nuestra aplicación.\n        var discount_amount_net_value = (frm.doc.discount_amount / (1 + (cur_frm.doc.taxes[0].rate / 100)));\n\n        if (discount_amount_net_value == NaN || discount_amount_net_value == undefined) {\n        } else {\n            discount_amount_tax_value = (discount_amount_net_value * (cur_frm.doc.taxes[0].rate / 100));\n            frm.doc.facelec_pr_total_iva = (frm.doc.facelec_pr_total_iva - discount_amount_tax_value);\n        }\n    },\n    before_save: function (frm, cdt, cdn) {\n        purchase_receipt_each_item(frm, cdt, cdn);\n    },\n});\n\nfrappe.ui.form.on(\"Purchase Receipt Item\", {\n    items_remove: function (frm) {\n        // es-GT: Este disparador corre al momento de eliminar una nueva fila.\n        // en-US: This trigger runs when removing a row.\n        // Vuelve a calcular los totales de FUEL, GOODS, SERVICES e IVA cuando se elimina una fila.\n\n        var fix_gt_tax_fuel = 0;\n        var fix_gt_tax_goods = 0;\n        var fix_gt_tax_services = 0;\n        var fix_gt_tax_iva = 0;\n\n        $.each(frm.doc.items || [], function (i, d) {\n            fix_gt_tax_fuel += flt(d.facelec_pr_gt_tax_net_fuel_amt);\n            fix_gt_tax_goods += flt(d.facelec_pr_gt_tax_net_goods_amt);\n            fix_gt_tax_services += flt(d.facelec_pr_gt_tax_net_services_amt);\n            fix_gt_tax_iva += flt(d.facelec_pr_sales_tax_for_this_row);\n        });\n\n        cur_frm.set_value(\"facelec_pr_gt_tax_fuel\", fix_gt_tax_fuel);\n        cur_frm.set_value(\"facelec_pr_gt_tax_goods\", fix_gt_tax_goods);\n        cur_frm.set_value(\"facelec_pr_gt_tax_services\", fix_gt_tax_services);\n        cur_frm.set_value(\"facelec_pr_total_iva\", fix_gt_tax_iva);\n    },\n    item_code: function (frm, cdt, cdn) {\n        // Trigger codigo de producto\n        var this_company_sales_tax_var = cur_frm.doc.taxes[0].rate;\n        refresh_field('qty');\n    },\n    qty: function (frm, cdt, cdn) {\n        // Trigger cantidad\n        shs_purchase_receipt_calculation(frm, cdt, cdn);\n    },\n    conversion_factor: function (frm, cdt, cdn) {\n        // Trigger factor de conversion\n        shs_purchase_receipt_calculation(frm, cdt, cdn);\n    },\n    rate: function (frm, cdt, cdn) {\n        shs_purchase_receipt_calculation(frm, cdt, cdn);\n    },\n    shs_amount_for_back_calc: function (frm, cdt, cdn) {\n        frm.doc.items.forEach((row, index) => {\n            var a = row.rate;\n            var b = row.qty;\n            var c = row.amount;\n\n            let calcu = goalSeek({\n                Func: redondeo_purchase_receipt,\n                aFuncParams: [b, a],\n                oFuncArgTarget: {\n                    Position: 0\n                },\n                Goal: row.shs_amount_for_back_calc,\n                Tol: 0.001,\n                maxIter: 10000\n            });\n            console.log(calcu);\n\n            frm.doc.items[index].qty = calcu;\n            frm.doc.items[index].stock_qty = calcu;\n            frm.doc.items[index].amount = calcu * frm.doc.items[index].rate;\n            frm.refresh_field(\"items\");\n        });\n    }\n});\n\n\nfunction redondeo_purchase_receipt(a, b) {\n    return a * b;\n}\n/* ----------------------------------------------------------------------------------------------------------------- */","import { valNit } from './facelec.js';\n\n// console.log(\"Hello world from Purchase Order\");\n\n/* Purchase Order------------------------------------------------------------------------------------------------------- */\nfunction purchase_order_each_item(frm, cdt, cdn) {\n    frm.doc.items.forEach((item) => {\n        shs_purchase_order_calculation(frm, \"Purchase Order Item\", item.name);\n    });\n}\n\n// Calculos para Orden de Compra\nfunction shs_purchase_order_calculation(frm, cdt, cdn) {\n    cur_frm.refresh_fields();\n    var this_company_sales_tax_var = cur_frm.doc.taxes[0].rate;\n\n    var this_row_amount = 0;\n    var this_row_stock_qty = 0;\n    var this_row_tax_rate = 0;\n    var this_row_tax_amount = 0;\n    var this_row_taxable_amount = 0;\n\n    frm.doc.items.forEach((item_row, index) => {\n\n        if (item_row.name == cdn) {\n            this_row_amount = (item_row.qty * item_row.rate);\n            this_row_stock_qty = (item_row.qty * item_row.conversion_factor);\n            this_row_tax_rate = (item_row.facelec_po_tax_rate_per_uom);\n            this_row_tax_amount = (this_row_stock_qty * this_row_tax_rate);\n            this_row_taxable_amount = (this_row_amount - this_row_tax_amount);\n\n            frm.doc.items[index].facelec_po_other_tax_amount = ((item_row.facelec_po_tax_rate_per_uom * (item_row.qty * item_row.conversion_factor)));\n            //OJO!  No s epuede utilizar stock_qty en los calculos, debe de ser qty a puro tubo!\n            frm.doc.items[index].facelec_po_amount_minus_excise_tax = ((item_row.qty * item_row.rate) - ((item_row.qty * item_row.conversion_factor) * item_row.facelec_po_tax_rate_per_uom));\n\n            if (item_row.facelec_po_is_fuel) {\n                frm.doc.items[index].facelec_po_gt_tax_net_fuel_amt = (item_row.facelec_po_amount_minus_excise_tax / (1 + (this_company_sales_tax_var / 100)));\n                frm.doc.items[index].facelec_po_sales_tax_for_this_row = (item_row.facelec_po_gt_tax_net_fuel_amt * (this_company_sales_tax_var / 100));\n                // Sumatoria de todos los que tengan el check combustibles\n                let total_fuel = 0;\n                $.each(frm.doc.items || [], function (i, d) {\n                    if (d.facelec_po_is_fuel == true) {\n                        total_fuel += flt(d.facelec_po_gt_tax_net_fuel_amt);\n                    };\n                });\n                frm.doc.facelec_po_gt_tax_fuel = total_fuel;\n            };\n\n            if (item_row.facelec_po_is_good) {\n                frm.doc.items[index].facelec_po_gt_tax_net_goods_amt = (item_row.facelec_po_amount_minus_excise_tax / (1 + (this_company_sales_tax_var / 100)));\n                frm.doc.items[index].facelec_po_sales_tax_for_this_row = (item_row.facelec_po_gt_tax_net_goods_amt * (this_company_sales_tax_var / 100));\n                // Sumatoria de todos los que tengan el check bienes\n                let total_goods = 0;\n                $.each(frm.doc.items || [], function (i, d) {\n                    if (d.facelec_po_is_good == true) {\n                        total_goods += flt(d.facelec_po_gt_tax_net_goods_amt);\n                    };\n                });\n                frm.doc.facelec_po_gt_tax_goods = total_goods;\n            };\n\n            if (item_row.facelec_po_is_service) {\n                frm.doc.items[index].facelec_po_gt_tax_net_services_amt = (item_row.facelec_po_amount_minus_excise_tax / (1 + (this_company_sales_tax_var / 100)));\n                frm.doc.items[index].facelec_po_sales_tax_for_this_row = (item_row.facelec_po_gt_tax_net_services_amt * (this_company_sales_tax_var / 100));\n                // Sumatoria de todos los que tengan el check servicios\n                let total_servi = 0;\n                $.each(frm.doc.items || [], function (i, d) {\n                    if (d.facelec_po_is_service == true) {\n                        total_servi += flt(d.facelec_po_gt_tax_net_services_amt);\n                    };\n                });\n                frm.doc.facelec_po_gt_tax_services = total_servi;\n            };\n\n            let full_tax_iva = 0;\n            $.each(frm.doc.items || [], function (i, d) {\n                full_tax_iva += flt(d.facelec_po_sales_tax_for_this_row);\n            });\n            frm.doc.facelec_po_total_iva = full_tax_iva;\n        };\n    });\n}\n\nfrappe.ui.form.on(\"Purchase Order\", {\n    onload_post_render: function (frm, cdt, cdn) {\n        // en-US: Enabling event listeners for child tables\n        // es-GT: Habilitando escuchadores de eventos en las tablas hijas del tipo de documento principal\n        frm.fields_dict.items.grid.wrapper.on('click focusout blur', 'input[data-fieldname=\"item_code\"][data-doctype=\"Purchase Order Item\"]', function (e) {\n            shs_purchase_order_calculation(frm, cdt, cdn);\n            purchase_order_each_item(frm, cdt, cdn);\n        });\n\n        frm.fields_dict.items.grid.wrapper.on('click', 'input[data-fieldname=\"uom\"][data-doctype=\"Purchase Order Item\"]', function (e) {\n            purchase_order_each_item(frm, cdt, cdn);\n        });\n\n        frm.fields_dict.items.grid.wrapper.on('blur focusout', 'input[data-fieldname=\"uom\"][data-doctype=\"Purchase Order Item\"]', function (e) {\n            purchase_order_each_item(frm, cdt, cdn);\n        });\n\n        // Do not refresh with each_item in Mouse leave! just recalculate\n        frm.fields_dict.items.grid.wrapper.on('mouseleave', 'input[data-fieldname=\"uom\"][data-doctype=\"Purchase Order Item\"]', function (e) {\n            shs_purchase_order_calculation(frm, cdt, cdn);\n        });\n\n        // This part might seem counterintuitive, but it is the \"next\" field in tab order after item code, which helps for a \"creative\" strategy to update everything after pressing TAB out of the item code field.  FIXME\n        frm.fields_dict.items.grid.wrapper.on('focus', 'input[data-fieldname=\"item_name\"][data-doctype=\"Purchase Order Item\"]', function (e) {\n            purchase_order_each_item(frm, cdt, cdn);\n        });\n\n        frm.fields_dict.items.grid.wrapper.on('blur focusout', 'input[data-fieldname=\"qty\"][data-doctype=\"Purchase Order Item\"]', function (e) {\n            purchase_order_each_item(frm, cdt, cdn);\n        });\n\n        // Do not refresh with each_item in Mouse leave! just recalculate\n        frm.fields_dict.items.grid.wrapper.on('mouseleave', 'input[data-fieldname=\"qty\"][data-doctype=\"Purchase Order Item\"]', function (e) {\n            purchase_order_each_item(frm, cdt, cdn);\n            shs_purchase_order_calculation(frm, cdt, cdn);\n        });\n\n        // DO NOT USE Keyup, ??  FIXME FIXME FIXME FIXME FIXME  este hace calculos bien\n        frm.fields_dict.items.grid.wrapper.on('blur focusout', 'input[data-fieldname=\"conversion_factor\"][data-doctype=\"Purchase Order Item\"]', function (e) {\n            //  IMPORTANT! IMPORTANT!  This is the one that gets the calculations correct!\n            // Trying to calc first, then refresh, or no refresh at all...\n            purchase_order_each_item(frm, cdt, cdn);\n            cur_frm.refresh_field(\"conversion_factor\");\n        });\n\n        // This specific one is only for keyup events, to recalculate all. Only on blur will it refresh everything!\n        // Do not refresh with each_item in Mouse leave OR keyup! just recalculate\n        frm.fields_dict.items.grid.wrapper.on('keyup mouseleave focusout', 'input[data-fieldname=\"conversion_factor\"][data-doctype=\"Purchase Order Item\"]', function (e) {\n            // Trying to calc first, then refresh, or no refresh at all...\n            shs_purchase_order_calculation(frm, cdt, cdn);\n            purchase_order_each_item(frm, cdt, cdn);\n            cur_frm.refresh_field(\"conversion_factor\");\n        });\n\n        // en-US: Enabling event listeners in the main doctype\n        // es-GT: Habilitando escuchadores de eventos en el tipo de documento principal\n        // When ANY key is released after being pressed\n        cur_frm.fields_dict.supplier.$input.on(\"keyup\", function (evt) {\n            // shs_purchase_order_calculation(frm, cdt, cdn);\n            // purchase_order_each_item(frm, cdt, cdn);\n            // refresh_field('qty');\n        });\n\n        // When mouse leaves the field\n        cur_frm.fields_dict.supplier.$input.on(\"mouseleave blur focusout\", function (evt) {\n            shs_purchase_order_calculation(frm, cdt, cdn);\n        });\n\n        // Mouse clicks over the items field\n        cur_frm.fields_dict.items.$wrapper.on(\"click\", function (evt) {\n            purchase_order_each_item(frm, cdt, cdn);\n        });\n\n        // Focusout from the field\n        cur_frm.fields_dict.taxes_and_charges.$input.on(\"focusout\", function (evt) {\n            shs_purchase_order_calculation(frm, cdt, cdn);\n        });\n    },\n    facelec_po_nit: function (frm) {\n        // Funcion para validar NIT: Se ejecuta cuando exista un cambio en el campo de NIT\n        valNit(frm.doc.facelec_po_nit, frm.doc.supplier, frm);\n    },\n    discount_amount: function (frm) {\n        // Trigger Monto de descuento\n        var tax_before_calc = frm.doc.facelec_po_total_iva;\n        // es-GT: Este muestra el IVA que se calculo por medio de nuestra aplicación.\n        var discount_amount_net_value = (frm.doc.discount_amount / (1 + (cur_frm.doc.taxes[0].rate / 100)));\n\n        if (discount_amount_net_value == NaN || discount_amount_net_value == undefined) {\n        } else {\n            discount_amount_tax_value = (discount_amount_net_value * (cur_frm.doc.taxes[0].rate / 100));\n            frm.doc.facelec_po_total_iva = (frm.doc.facelec_po_total_iva - discount_amount_tax_value);\n        }\n    },\n    before_save: function (frm, cdt, cdn) {\n        purchase_order_each_item(frm, cdt, cdn);\n    },\n});\n\nfrappe.ui.form.on(\"Purchase Order Item\", {\n    items_remove: function (frm) {\n        // es-GT: Este disparador corre al momento de eliminar una nueva fila.\n        // en-US: This trigger runs when removing a row.\n        // Vuelve a calcular los totales de FUEL, GOODS, SERVICES e IVA cuando se elimina una fila.\n\n        var fix_gt_tax_fuel = 0;\n        var fix_gt_tax_goods = 0;\n        var fix_gt_tax_services = 0;\n        var fix_gt_tax_iva = 0;\n\n        $.each(frm.doc.items || [], function (i, d) {\n            fix_gt_tax_fuel += flt(d.facelec_po_gt_tax_net_fuel_amt);\n            fix_gt_tax_goods += flt(d.facelec_po_gt_tax_net_goods_amt);\n            fix_gt_tax_services += flt(d.facelec_po_gt_tax_net_services_amt);\n            fix_gt_tax_iva += flt(d.facelec_po_sales_tax_for_this_row);\n        });\n\n        cur_frm.set_value(\"facelec_po_gt_tax_fuel\", fix_gt_tax_fuel);\n        cur_frm.set_value(\"facelec_po_gt_tax_goods\", fix_gt_tax_goods);\n        cur_frm.set_value(\"facelec_po_gt_tax_services\", fix_gt_tax_services);\n        cur_frm.set_value(\"facelec_po_total_iva\", fix_gt_tax_iva);\n    },\n    item_code: function (frm, cdt, cdn) {\n        // Trigger codigo de producto\n        var this_company_sales_tax_var = cur_frm.doc.taxes[0].rate;\n        refresh_field('qty');\n    },\n    qty: function (frm, cdt, cdn) {\n        // Trigger cantidad\n        shs_purchase_order_calculation(frm, cdt, cdn);\n    },\n    conversion_factor: function (frm, cdt, cdn) {\n        // Trigger factor de conversion\n        shs_purchase_order_calculation(frm, cdt, cdn);\n    },\n    rate: function (frm, cdt, cdn) {\n        shs_purchase_order_calculation(frm, cdt, cdn);\n    }\n});\n\n/* ----------------------------------------------------------------------------------------------------------------- */","//console.log(\"Hello world from Supplier Quotation\");\nimport { valNit } from './facelec.js';\n\n/* Supplier Quotation (Presupuesto Proveedor) ------------------------------------------------------------------------------------------------------- */\nfunction supplier_quotation_each_item(frm, cdt, cdn) {\n    frm.doc.items.forEach((item) => {\n        shs_supplier_quotation_calculation(frm, \"Supplier Quotation Item\", item.name);\n    });\n}\n\n// Calculos para Cotizacion de proveedor\nfunction shs_supplier_quotation_calculation(frm, cdt, cdn) {\n    cur_frm.refresh_fields();\n    var this_company_sales_tax_var = cur_frm.doc.taxes[0].rate;\n\n    var this_row_amount = 0;\n    var this_row_stock_qty = 0;\n    var this_row_tax_rate = 0;\n    var this_row_tax_amount = 0;\n    var this_row_taxable_amount = 0;\n\n    frm.doc.items.forEach((item_row, index) => {\n\n        if (item_row.name == cdn) {\n            this_row_amount = (item_row.qty * item_row.rate);\n            this_row_stock_qty = (item_row.qty * item_row.conversion_factor);\n            this_row_tax_rate = (item_row.shs_spq_tax_rate_per_uom);\n            this_row_tax_amount = (this_row_stock_qty * this_row_tax_rate);\n            this_row_taxable_amount = (this_row_amount - this_row_tax_amount);\n\n            frm.doc.items[index].shs_spq_other_tax_amount = ((item_row.shs_spq_tax_rate_per_uom * (item_row.qty * item_row.conversion_factor)));\n            //OJO!  No s epuede utilizar stock_qty en los calculos, debe de ser qty a puro tubo!\n            frm.doc.items[index].shs_spq_amount_minus_excise_tax = ((item_row.qty * item_row.rate) - ((item_row.qty * item_row.conversion_factor) * item_row.shs_spq_tax_rate_per_uom));\n\n            if (item_row.shs_spq_is_fuel) {\n                frm.doc.items[index].shs_spq_gt_tax_net_fuel_amt = (item_row.shs_spq_amount_minus_excise_tax / (1 + (this_company_sales_tax_var / 100)));\n                frm.doc.items[index].shs_spq_sales_tax_for_this_row = (item_row.shs_spq_gt_tax_net_fuel_amt * (this_company_sales_tax_var / 100));\n                // Sumatoria de todos los que tengan el check combustibles\n                let total_fuel = 0;\n                $.each(frm.doc.items || [], function (i, d) {\n                    if (d.shs_spq_is_fuel == true) {\n                        total_fuel += flt(d.shs_spq_gt_tax_net_fuel_amt);\n                    };\n                });\n                frm.doc.shs_spq_gt_tax_fuel = total_fuel;\n            };\n\n            if (item_row.shs_spq_is_good) {\n                frm.doc.items[index].shs_spq_gt_tax_net_goods_amt = (item_row.shs_spq_amount_minus_excise_tax / (1 + (this_company_sales_tax_var / 100)));\n                frm.doc.items[index].shs_spq_sales_tax_for_this_row = (item_row.shs_spq_gt_tax_net_goods_amt * (this_company_sales_tax_var / 100));\n                // Sumatoria de todos los que tengan el check bienes\n                let total_goods = 0;\n                $.each(frm.doc.items || [], function (i, d) {\n                    if (d.shs_spq_is_good == true) {\n                        total_goods += flt(d.shs_spq_gt_tax_net_goods_amt);\n                    };\n                });\n                frm.doc.shs_spq_gt_tax_goods = total_goods;\n            };\n\n            if (item_row.shs_spq_is_service) {\n                frm.doc.items[index].shs_spq_gt_tax_net_services_amt = (item_row.shs_spq_amount_minus_excise_tax / (1 + (this_company_sales_tax_var / 100)));\n                frm.doc.items[index].shs_spq_sales_tax_for_this_row = (item_row.shs_spq_gt_tax_net_services_amt * (this_company_sales_tax_var / 100));\n                // Sumatoria de todos los que tengan el check servicios\n                let total_servi = 0;\n                $.each(frm.doc.items || [], function (i, d) {\n                    if (d.shs_spq_is_service == true) {\n                        total_servi += flt(d.shs_spq_gt_tax_net_services_amt);\n                    };\n                });\n                frm.doc.shs_spq_gt_tax_services = total_servi;\n            };\n\n            let full_tax_iva = 0;\n            $.each(frm.doc.items || [], function (i, d) {\n                full_tax_iva += flt(d.shs_spq_sales_tax_for_this_row);\n            });\n            frm.doc.shs_spq_total_iva = full_tax_iva;\n        };\n    });\n}\n\nfrappe.ui.form.on(\"Supplier Quotation\", {\n    onload_post_render: function (frm, cdt, cdn) {\n        // en-US: Enabling event listeners for child tables\n        // es-GT: Habilitando escuchadores de eventos en las tablas hijas del tipo de documento principal\n        frm.fields_dict.items.grid.wrapper.on('click focusout blur', 'input[data-fieldname=\"item_code\"][data-doctype=\"Supplier Quotation Item\"]', function (e) {\n            shs_supplier_quotation_calculation(frm, cdt, cdn);\n            supplier_quotation_each_item(frm, cdt, cdn);\n        });\n\n        frm.fields_dict.items.grid.wrapper.on('click', 'input[data-fieldname=\"uom\"][data-doctype=\"Supplier Quotation Item\"]', function (e) {\n            supplier_quotation_each_item(frm, cdt, cdn);\n        });\n\n        frm.fields_dict.items.grid.wrapper.on('blur focusout', 'input[data-fieldname=\"uom\"][data-doctype=\"Supplier Quotation Item\"]', function (e) {\n            supplier_quotation_each_item(frm, cdt, cdn);\n        });\n\n        // Do not refresh with each_item in Mouse leave! just recalculate\n        frm.fields_dict.items.grid.wrapper.on('blur', 'input[data-fieldname=\"uom\"][data-doctype=\"Supplier Quotation Item\"]', function (e) {\n            shs_supplier_quotation_calculation(frm, cdt, cdn);\n        });\n\n        // This part might seem counterintuitive, but it is the \"next\" field in tab order after item code, which helps for a \"creative\" strategy to update everything after pressing TAB out of the item code field.  FIXME\n        frm.fields_dict.items.grid.wrapper.on('blur', 'input[data-fieldname=\"item_name\"][data-doctype=\"Supplier Quotation Item\"]', function (e) {\n            supplier_quotation_each_item(frm, cdt, cdn);\n        });\n\n        frm.fields_dict.items.grid.wrapper.on('blur focusout', 'input[data-fieldname=\"qty\"][data-doctype=\"Supplier Quotation Item\"]', function (e) {\n            supplier_quotation_each_item(frm, cdt, cdn);\n        });\n\n        // Do not refresh with each_item in Mouse leave! just recalculate\n        frm.fields_dict.items.grid.wrapper.on('blur', 'input[data-fieldname=\"qty\"][data-doctype=\"Supplier Quotation Item\"]', function (e) {\n            supplier_quotation_each_item(frm, cdt, cdn);\n            shs_supplier_quotation_calculation(frm, cdt, cdn);\n        });\n\n        // DO NOT USE Keyup, ??  FIXME FIXME FIXME FIXME FIXME  este hace calculos bien\n        frm.fields_dict.items.grid.wrapper.on('blur focusout', 'input[data-fieldname=\"conversion_factor\"][data-doctype=\"Supplier Quotation Item\"]', function (e) {\n            //  IMPORTANT! IMPORTANT!  This is the one that gets the calculations correct!\n            // Trying to calc first, then refresh, or no refresh at all...\n            supplier_quotation_each_item(frm, cdt, cdn);\n            cur_frm.refresh_field(\"conversion_factor\");\n        });\n\n        // This specific one is only for keyup events, to recalculate all. Only on blur will it refresh everything!\n        // Do not refresh with each_item in Mouse leave OR keyup! just recalculate\n        frm.fields_dict.items.grid.wrapper.on('blur mouseleave focusout', 'input[data-fieldname=\"conversion_factor\"][data-doctype=\"Supplier Quotation Item\"]', function (e) {\n            // Trying to calc first, then refresh, or no refresh at all...\n            shs_supplier_quotation_calculation(frm, cdt, cdn);\n            supplier_quotation_each_item(frm, cdt, cdn);\n            cur_frm.refresh_field(\"conversion_factor\");\n        });\n\n        // en-US: Enabling event listeners in the main doctype\n        // es-GT: Habilitando escuchadores de eventos en el tipo de documento principal\n        // When ANY key is released after being pressed\n        cur_frm.fields_dict.supplier.$input.on(\"keyup\", function (evt) {\n            // shs_supplier_quotation_calculation(frm, cdt, cdn);\n            // supplier_quotation_each_item(frm, cdt, cdn);\n            // refresh_field('qty');\n        });\n\n        // When mouse leaves the field\n        cur_frm.fields_dict.supplier.$input.on(\"mouseleave blur focusout\", function (evt) {\n            shs_supplier_quotation_calculation(frm, cdt, cdn);\n        });\n\n        // Mouse clicks over the items field\n        cur_frm.fields_dict.items.$wrapper.on(\"click\", function (evt) {\n            supplier_quotation_each_item(frm, cdt, cdn);\n        });\n\n        // Focusout from the field\n        cur_frm.fields_dict.taxes_and_charges.$input.on(\"focusout\", function (evt) {\n            shs_supplier_quotation_calculation(frm, cdt, cdn);\n        });\n    },\n    shs_spq_nit: function (frm) {\n        // Funcion para validar NIT: Se ejecuta cuando exista un cambio en el campo de NIT\n        valNit(frm.doc.shs_spq_nit, frm.doc.supplier, frm);\n    },\n    discount_amount: function (frm) {\n        // Trigger Monto de descuento\n        var tax_before_calc = frm.doc.shs_spq_total_iva;\n        // es-GT: Este muestra el IVA que se calculo por medio de nuestra aplicación.\n        var discount_amount_net_value = (frm.doc.discount_amount / (1 + (cur_frm.doc.taxes[0].rate / 100)));\n\n        if (discount_amount_net_value == NaN || discount_amount_net_value == undefined) {\n        } else {\n            // console.log(\"El descuento parece ser un numero definido, calculando con descuento.\");\n            discount_amount_tax_value = (discount_amount_net_value * (cur_frm.doc.taxes[0].rate / 100));\n            // console.log(\"El IVA del descuento es:\" + discount_amount_tax_value);\n            frm.doc.shs_spq_total_iva = (frm.doc.shs_spq_total_iva - discount_amount_tax_value);\n            // console.log(\"El IVA ya sin el iva del descuento es ahora:\" + frm.doc.facelec_total_iva);\n        }\n    },\n    before_save: function (frm, cdt, cdn) {\n        supplier_quotation_each_item(frm, cdt, cdn);\n    },\n});\n\nfrappe.ui.form.on(\"Supplier Quotation Item\", {\n    items_remove: function (frm, cdt, cdn) {\n        // es-GT: Este disparador corre al momento de eliminar una nueva fila.\n        // en-US: This trigger runs when removing a row.\n        // Vuelve a calcular los totales de FUEL, GOODS, SERVICES e IVA cuando se elimina una fila.\n\n        var fix_gt_tax_fuel = 0;\n        var fix_gt_tax_goods = 0;\n        var fix_gt_tax_services = 0;\n        var fix_gt_tax_iva = 0;\n\n        $.each(frm.doc.items || [], function (i, d) {\n            fix_gt_tax_fuel += flt(d.shs_spq_gt_tax_net_fuel_amt);\n            fix_gt_tax_goods += flt(d.shs_spq_gt_tax_net_goods_amt);\n            fix_gt_tax_services += flt(d.shs_spq_gt_tax_net_services_amt);\n            fix_gt_tax_iva += flt(d.shs_spq_sales_tax_for_this_row);\n        });\n\n        cur_frm.set_value(\"shs_spq_gt_tax_fuel\", fix_gt_tax_fuel);\n        cur_frm.set_value(\"shs_spq_gt_tax_goods\", fix_gt_tax_goods);\n        cur_frm.set_value(\"shs_spq_gt_tax_services\", fix_gt_tax_services);\n        cur_frm.set_value(\"shs_spq_total_iva\", fix_gt_tax_iva);\n    },\n    item_code: function (frm, cdt, cdn) {\n        // Trigger codigo de producto\n        var this_company_sales_tax_var = cur_frm.doc.taxes[0].rate;\n        // console.log(\"If you can see this, tax rate variable now exists, and its set to: \" + this_company_sales_tax_var);\n        refresh_field('qty');\n    },\n    qty: function (frm, cdt, cdn) {\n        // Trigger cantidad\n        shs_supplier_quotation_calculation(frm, cdt, cdn);\n    },\n    conversion_factor: function (frm, cdt, cdn) {\n        // Trigger factor de conversion\n        shs_supplier_quotation_calculation(frm, cdt, cdn);\n    },\n    rate: function (frm, cdt, cdn) {\n        shs_supplier_quotation_calculation(frm, cdt, cdn);\n    }\n});\n\n/* ----------------------------------------------------------------------------------------------------------------- */"],"names":["valNit","nit","cus_supp","frm","nit_validado","enable_save","nd","add","exec","toLowerCase","parseInt","i","length","frappe","show_alert","indicator","message","__","disable_save","goalSeek","oParams","g","Y","OldTarget","Tol","Goal","maxIter","oFuncArgTarget","propStr","aFuncParams","Position","iGuess","Math","random","setObjVal","Func","apply","This","abs","getObjVal","Obj","Value","Schema","pList","split","Len","Elem","Parts","Cur","facelec_tax_calc_new","cdt","cdn","this_company_sales_tax_var","cur_frm","doc","taxes","rate","items","forEach","item_row","index","name","amount","stock_qty","facelec_tax_rate_per_uom","facelec_other_tax_amount","qty","conversion_factor","facelec_amount_minus_excise_tax","refresh_field","factelecis_fuel","facelec_gt_tax_net_fuel_amt","facelec_sales_tax_for_this_row","facelec_is_good","facelec_gt_tax_net_goods_amt","facelec_is_service","facelec_gt_tax_net_services_amt","total_iva_factura","$","each","d","flt","set_value","each_item","item","facelec_total_iva","discount_amount_net_value","discount_amount","discount_amount_tax_value","facelec_otros_impuestos_fila","facelec_add_taxes","tax_account","total_sumatoria","facelec_tax_rate_per_uom_account","sumar_otros_impuestos_shs","item_row_1","index_1","undefined","shs_otros_impuestos","tax_row_2","index_2","account_head","totalizador","total","shs_total_other_tax","total_tax","shs_otro_impuesto","item_row_i","indice","cuenta","cuenta_b","estado","model","add_child","tax_row","pdf_button","cae_documento","add_custom_button","window","open","addClass","guardar_pdf","call","method","args","nombre_archivo","cae_de_factura_electronica","cae_factura_electronica","callback","reload_doc","generar_boton_factura","tipo_factura","let","serie_de_factura","mi_url","location","href","serie_factura","nombre_cliente","customer","pre_se","naming_series","data","url_nueva","replace","assign","generar_factura_sin_btn","verificacionCAE","modalidad","status","clear_custom_buttons","es_nota_de_debito","calculo_redondeo_pi","a","b","delivery_note_each_item","shs_delivery_note_calculation","refresh_fields","shs_dn_other_tax_amount","shs_dn_tax_rate_per_uom","shs_dn_amount_minus_excise_tax","shs_dn_is_fuel","shs_dn_gt_tax_net_fuel_amt","shs_dn_sales_tax_for_this_row","total_fuel","shs_dn_gt_tax_fuel","shs_dn_is_good","shs_dn_gt_tax_net_goods_amt","total_goods","shs_dn_gt_tax_goods","shs_dn_is_service","shs_dn_gt_tax_net_services_amt","total_servi","shs_dn_gt_tax_services","full_tax_iva","shs_dn_total_iva","redondeo_delivery_note","sales_order_each_item","shs_sales_order_calculation","shs_so_other_tax_amount","shs_so_tax_rate_per_uom","shs_so_amount_minus_excise_tax","shs_so_is_fuel","shs_so_gt_tax_net_fuel_amt","shs_so_sales_tax_for_this_row","shs_gt_tax_fuel","shs_so_is_good","shs_so_gt_tax_net_goods_amt","shs_so_gt_tax_goods","shs_so_is_service","shs_so_gt_tax_net_services_amt","shs_so_gt_tax_services","shs_so_total_iva","quotation_each_item","shs_quotation_calculation","coti_insertar_fila_otro_impuesto","coti_sumatoria_por_cuenta_items","facelec_qt_tax_rate_per_uom_account","facelec_qt_other_tax_amount","coti_sumatoria_otros_impuestos_por_cuenta","shs_tax_quotation","coti_total_de_otros_impuestos","facelec_qt_tax_rate_per_uom","facelec_qt_amount_minus_excise_tax","facelec_qt_is_fuel","facelec_qt_gt_tax_net_fuel_amt","facelec_qt_sales_tax_for_this_row","facelec_qt_gt_tax_fuel","facelec_qt_is_good","facelec_qt_gt_tax_net_goods_amt","facelec_qt_gt_tax_goods","facelec_qt_is_service","facelec_qt_gt_tax_net_services_amt","facelec_qt_gt_tax_services","facelec_qt_total_iva","pi_each_item","shs_purchase_invoice_calculation","pi_insertar_fila_otro_impuesto","pi_sumatoria_por_cuenta_items","facelec_p_tax_rate_per_uom_account","facelec_p_other_tax_amount","pi_sumatoria_otros_impuestos_por_cuenta","shs_pi_otros_impuestos","pi_total_de_otros_impuestos","facelec_p_tax_rate_per_uom","facelec_p_amount_minus_excise_tax","facelec_p_is_fuel","facelec_p_gt_tax_net_fuel_amt","facelec_p_sales_tax_for_this_row","facelec_p_gt_tax_fuel","facelec_p_is_good","facelec_p_gt_tax_net_goods_amt","facelec_p_gt_tax_goods","facelec_p_is_service","facelec_p_gt_tax_net_services_amt","facelec_p_gt_tax_services","facelec_p_total_iva","redondeo_sales_invoice","purchase_receipt_each_item","shs_purchase_receipt_calculation","facelec_pr_other_tax_amount","facelec_pr_tax_rate_per_uom","facelec_pr_amount_minus_excise_tax","facelec_pr_is_fuel","facelec_pr_gt_tax_net_fuel_amt","facelec_pr_sales_tax_for_this_row","facelec_pr_gt_tax_fuel","facelec_pr_is_good","facelec_pr_gt_tax_net_goods_amt","facelec_pr_gt_tax_goods","facelec_pr_is_service","facelec_pr_gt_tax_net_services_amt","facelec_pr_gt_tax_services","facelec_pr_total_iva","redondeo_purchase_receipt","purchase_order_each_item","shs_purchase_order_calculation","facelec_po_other_tax_amount","facelec_po_tax_rate_per_uom","facelec_po_amount_minus_excise_tax","facelec_po_is_fuel","facelec_po_gt_tax_net_fuel_amt","facelec_po_sales_tax_for_this_row","facelec_po_gt_tax_fuel","facelec_po_is_good","facelec_po_gt_tax_net_goods_amt","facelec_po_gt_tax_goods","facelec_po_is_service","facelec_po_gt_tax_net_services_amt","facelec_po_gt_tax_services","facelec_po_total_iva","supplier_quotation_each_item","shs_supplier_quotation_calculation","shs_spq_other_tax_amount","shs_spq_tax_rate_per_uom","shs_spq_amount_minus_excise_tax","shs_spq_is_fuel","shs_spq_gt_tax_net_fuel_amt","shs_spq_sales_tax_for_this_row","shs_spq_gt_tax_fuel","shs_spq_is_good","shs_spq_gt_tax_net_goods_amt","shs_spq_gt_tax_goods","shs_spq_is_service","shs_spq_gt_tax_net_services_amt","shs_spq_gt_tax_services","shs_spq_total_iva","console","log","ui","form","on","facelec_is_fuel","nit_face_customer","facelec_nit_proveedor","onload_post_render","fields_dict","grid","wrapper","e","$input","evt","taxes_and_charges","refresh","add_fetch","validate","const","mi_array","mi_array_dos","Array","from","tabla","JSON","stringify","generar_tabla_html","additional_discount_percentage","NaN","before_save","on_submit","cuentas_registradas","Object","keys","invoice_name","accounts","invoice_type","nombre_serie","numero_resolucion","items_add","items_move","before_items_remove","tax_account_n","otro_impuesto","i1","i2","splice","totalizar_valores","items_remove","item_code","uom","shs_amount_for_back_calc","row","calcu","$wrapper","shs_dn_nit","fix_gt_tax_fuel","fix_gt_tax_goods","fix_gt_tax_services","fix_gt_tax_iva","shs_so_nit","facelec_qt_nit","coti_total_otros_impuestos_eliminacion","supplier","facelec_nit_fproveedor","generar_tabla_html_factura_compra","serie","r","clear_table","pi_total_otros_impuestos_eliminacion","facelec_nit_prproveedor","facelec_po_nit","shs_spq_nit"],"mappings":"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"}